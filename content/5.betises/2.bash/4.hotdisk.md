---
navigation: true
title: HotDisk
main:
  fluid: false
---
:ellipsis{left=0px width=40rem top=10rem blur=140px}

# HotDisk
---

Quand on a un NAS avec plusieurs disques dans une buanderie, les temp√©ratures peuvent vite grimper. Or, un disque dur est tr√®s sensible aux temp√©ratures et peut subir de gros dommages s'il d√©passe une temp√©rature seuil pendant un certain temps. Apr√®s un √©t√© tr√®s chaud qui a fournit son lot de sueur froide en regardant la temp√©rature de mes disques, j'ai cherch√© un moyen de pouvoir automatiser l'extinction du serveur en cas de d√©passement prolonger de la temp√©rature maximale support√©e par mes disques.

N'ayant rien trouv√© de convaincant, je l'ai donc fait moi-m√™me.

- Le script lit la temp√©rature SMART de tous les disques SATA chaque minute.
- Il compte le nombre de minutes cons√©cutives o√π la temp√©rature est au-dessus ou en dessous du seuil.
- Il envoie des notifications Discord si le seuil est d√©pass√© ou si la temp√©rature redescend.
- Il d√©clenche l‚Äôarr√™t du syst√®me si la temp√©rature d√©passe la limite pendant la dur√©e configur√©e.
- Il enregistre toutes les temp√©ratures et l‚Äô√©tat des compteurs, et effectue automatiquement la rotation des journaux.

Puis tant qu'on y est, j'ai ajout√© un script d'installation qui installe le script, le rend √©xecutable, cr√©e un service systemd et un timer systemd et l'active. Le script d'installation permet aussi de r√©gler les diff√©rentes variables:

| Variable              | Description                                                                 | Valeur par d√©faut                             |
|-----------------------|------------------------------------------------------------------------------|-----------------------------------------------|
| `MAX_TEMP`            | Temp√©rature maximale autoris√©e (¬∞C) avant le d√©but du compte √† rebours d‚Äôarr√™t | `60`                                          |
| `HOT_DURATION`        | Minutes cons√©cutives au-dessus de `MAX_TEMP` avant l‚Äôarr√™t du syst√®me        | `5`                                           |
| `COOL_RESET_DURATION` | Minutes cons√©cutives en dessous de `MAX_TEMP` pour r√©initialiser les compteurs | `5`                                           |
| `LOG_FILE`            | Chemin du fichier journal principal                                          | `/var/log/hdd_temp_monitor.log`               |
| `LOG_ROTATE_COUNT`    | Nombre de fichiers journaux √† conserver                                     | `7`                                           |
| `LOG_ROTATE_PERIOD`   | P√©riode de rotation des journaux (`daily` ou `weekly`)                       | `daily`                                       |
| `DISCORD_WEBHOOK`     | URL du webhook Discord pour les notifications                               | _Obligatoire_                                 |

Il execute aussi un autre script qui param√®tre le logrotate avec les √©l√©ments configur√©s pr√©d√©demment. Et enfin, le script d'installation peut etre execut√© via un simple curl + execution d'un dernier script pour les plus flemmard.

Il a fallu √©galement g√©rer le sujet du root sans sudo, du sudo seul, de l'utilisateur sans sudo, les divers cas d'erreur (d√©pendances manquantes, erreur dans les permissions, cr√©ations de fichier, de lecture des donn√©es des disques, etc...)

Et l'acces concurrent au fichier de statuts.

Plus d'infos directement sur le repo :

 
  ::card
  #title
    üìú __HotDisk__
  #description
  [Gardez vos disques au frais !](https://git.djeex.fr/Djeex/hotdisk)
  ::
