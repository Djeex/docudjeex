---
navigation: true
title: Socat Proxy
main:
  fluid: false
---
:ellipsis{left=0px width=40rem top=10rem blur=140px}

# Socat Proxy
---

Ce projet r√©pond √† un cas d'usage probl√©matique :
- J'ai [Beszel](https://beszel.dev/), un conteneur de monitoring en mode host, n√©cessitant d'exposer le socket de Docker afin qu'il r√©cup√®re les stats des conteneurs
- Afin de ne pas laisser le socket compl√®tement ouvert pour Beszel, j'ai [Docker Socket Proxy](https://github.com/Tecnativa/docker-socket-proxy), un conteneur qui se place entre le scoket de docker et le conteneur qui en a besoin, et qui filtre le requ√™tes en param√©trant les bonnes permissions pour ne pas tout exposer au conteneur qui l'utilise.

Probl√®me, si __Beszel__ est en mode host, il doit contacter __Docker Socket Proxy__ directement sur un port de l'host, c'est √† dire en exposant un port de __Docker Socket Proxy__. Ce qui fait que n'importe quel conteneur/application sur mon host peut l'appeler et utiliser le socket docker.

C'est l√† qu'intervient [Socat Proxy](https://git.djeex.fr/Djeex/socat-proxy). Ce dernier est un conteneur qui :

- Cr√©e un socket UNIX
- Ecoute ce socket
- Envoie les requetes vers Docker Socket Proxy et vice versa
- Permet de remplacer le vrai socket docker en exposant le socket proxy cr√©√©, dans le conteneur final via un bind mount (ici, Beszel)

Ainsi, un filtre comme Docker Socket Proxy dialogue avec Socat Proxy dans leur propre r√©seau isol√© (en mode bridge), et le bind mount du socket UNIX cr√©√© est localis√© sur l'host dans un dossier avec les permissions n√©cessaires pour ne pas etre visible des autres conteneurs/applicatifs.

En gros :

![](/img/betises/socat-proxy.svg)


Par exemple, pour Beszel cela rendrait comme ceci :

```yaml
services:
  socat-proxy:
    image: git.djeex.fr/djeex/socat-proxy:latest
    container_name: socat-proxy-beszel
    environment:
      - TARGET_HOST=${TARGET_HOST}
      - TARGET_PORT=${TARGET_PORT}
      - UNIX_SOCKET_PATH=${UNIX_SOCKET_PATH}
      - HOST_SOCKET_PATH=${HOST_SOCKET_PATH}
      - UNIX_SOCKET_NAME=${UNIX_SOCKET_NAME}
    volumes:
      - ${HOST_SOCKET_PATH}:${UNIX_SOCKET_PATH}
    restart: unless-stopped
    depends_on:
      - ${TARGET_HOST}

  socket-proxy:
    image: lscr.io/linuxserver/socket-proxy:latest
    container_name: ${TARGET_HOST}
    security_opt:
      - no-new-privileges:true
    environment:
      - CONTAINERS=1
      - INFO=1
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock:ro
    restart: unless-stopped
    read_only: true
    tmpfs:
      - /run

  beszel-agent:
    image: henrygd/beszel-agent:latest
    container_name: beszel-agent
    restart: unless-stopped
    network_mode: host
    security_opt:
      - no-new-privileges:true
    volumes:
      - ${HOST_SOCKET_PATH}/${UNIX_SOCKET_NAME}:/var/run/docker.sock:ro
    environment:
      - #... your Beszel environment var 
    depends_on:
      - socat-proxy
```

Plus d'infos directement sur le repo :

 
  ::card
  #title
    üêã __Socat Proxy__
  #description
  [A lighteweight bind mount socket proxy](https://git.djeex.fr/Djeex/socat-proxy)
  ::
