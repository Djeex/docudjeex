---
navigation: true
title: Nextcloud
main:
  fluid: false
---
:ellipsis{left=0px width=40rem top=10rem blur=140px}
# Nextcloud

::alert{type="info"}
üéØ __Objectifs :__ installer [Nextcloud](https://nextcloud.com/) pour g√©rer vos photos sur tout vos appareils.
::

[Nextcloud](https://nextcloud.com/) est une solution qui vous permet d'acc√©der √† vos donn√©es sur tout vos appareils, et de les synchroniser. Nexctloud dispose √©galement de fonctionnalit√©s de collaboration, de calendrier et bien d'autres. Cette solution remplace des solutions du type Google Drive, iCloud, ou encore OneDrive.

![Picture](/img/serveex/nextcloud.png)

## Installation
---
::alert{type="info"}
:::list{type="info"}
- Nous utiliserons l'image docker maintenue par [LinuxServer.io](https://docs.linuxserver.io/images/docker-nextcloud/)
:::
::

Structure des fichiers

```console
root
‚îî‚îÄ‚îÄ docker
    ‚îî‚îÄ‚îÄ nextcloud
        ‚îú‚îÄ‚îÄ config
        ‚îú‚îÄ‚îÄ data
        ‚îú‚îÄ‚îÄ compose.yaml
        ‚îî‚îÄ‚îÄ .env
```

Ouvrez Dockge, cliquez sur `compose`, appelez la stack `nextcloud` puis copiez collez ceci :

```yaml
---
services:
  nextcloud:
    image: lscr.io/linuxserver/nextcloud:latest
    container_name: nextcloud
    environment:
      - PUID=${PUID}
      - PGID=${GUID}
      - TZ=Etc/UTC
    volumes:
      - /docker/nextcloud/config:/config
      - /docker/nextcloud/data:/data
    ports:
      - ${PORT}:443
    restart: unless-stopped
```

::alert{type="info"}
:::list{type="info"}
- Si vous avez un NAS ou un disque r√©seau partag√© via [samba](/generalites/reseau/samba) pour stocker vos donn√©es, remplacez `/docker/nextcloud/data` par le chemin d'acc√®s de votre dossier partag√©.
:::
::

Trouvez votre `PUID` et votre `GUID` en tapant la commande suivante :

```shell
id nomdutilisateur
```
Et renseignez le `.env` avec le port souhait√©, et les infos que vous avez trouv√©es, par exemple :

```properties
PUID=1000
GUID=1000
PORT=4545
```

D√©ployez la stack et rendez-vous sur `http://ipduserveur:4545` et suivez les instructions.

::alert{type="danger"}
:::list{type="danger"}
- __En cas d'√©chec :__ v√©rifiez les r√®gles de votre pare-feu.
:::
::

## Exposer Nextcloud avec Swag
---
Tout l'int√©r√™t d'une telle solution, c'est de pouvoir y acc√©der √† distance et sur tout vos appareils. Pour cela, nous allons exposer Nextcloud via Swag.

::alert{type="info"}
:::list{type="info"}
- Nous partons du principe que vous avez le sous-domaine `nextcloud.mondomaine.fr` avec un `CNAME` qui pointe vers `mondomaine.fr` dans votre [zone DNS](/generalites/reseau/dns). Et que bien s√ªr, [√† moins que vous utilisiez Cloudflare Zero Trust](/serveex/securite/cloudflare), le port `443` de votre box pointe bien sur le port `443` de votre serveur via [les r√®gles NAT](/generalites/reseau/nat).
:::
::

Dans Dockge, rendez-vous dans la stack de SWAG et √©ditez le compose en ajoutant le r√©seau de nextcloud :

```yaml
services:
  swag:
     container_name: # ...
      # ... 
     networks:               # Relie le conteneur au r√©seau custom 
      # ...           
      - nextcloud            # Nom du r√©seau d√©clar√© dans la stack
    
networks:                    # D√©finit le r√©seau custom
  # ...
  nextcloud:                    # Nom du r√©seau d√©clar√© dans la stack
    name: nextcloud_default  # Nom v√©ritable du r√©seau externe
    external: true           # Pr√©cise que c'est un r√©seau √† rechercher en externe
```

::alert{type="info"}
:::list{type="info"}
- Ici nous partons du principe que le nom du r√©seau de nextcloud est `nextcloud_default`. Vous pouvez v√©rifier que la connexion est op√©rationnelle en visitant le dashboard de SWAG en tapant http://ipduserveur:81.
:::
::

Relancez la stack en cliquant sur "d√©ployer" et patientez le temps que SWAG soit compl√®tement op√©rationnel.

Dans les fichiers de nextcloud, √©ditez le fichier `config.php`.

::alert{type="success"}
‚ú® __Astuce :__ vous pouvez utiliser [File Browser](/serveex/files/file-browser) pour naviguer dans vos fichier et √©diter vos documents au lieu d'utiliser les commandes du terminal.
::

```shell
sudo vi /docker/nextcloud/config/www/nextcloud/config/config.php
```

Entrez en modification avec la touche `i` et copiez les informations suivantes __avant__ `);`.

```js
'trusted_proxies' => [gethostbyname('swag')],  'overwrite.cli.url' => 'https://nextcloud.example.com/',
'overwritehost' => 'nextcloud.example.com',
'overwriteprotocol' => 'https',
```

Ajoutez √©galement votre nom de domaine dans la section `array` , cela devrait ressembler √† ceci
```js
 array (
   0 => '192.168.0.1:444', # Cette ligne est surement diff√©rente chez vous, ne la modifiez pas !
   1 => 'nextcloud.mondomaine.fr', # Renseignez votre domaine
  ),
```
Appuyez sur `Echap` puis sauvegardez et quittez en tapant `:x` puis en appuyant sur `Entr√©e`.

Dans les dossiers de Swag, cr√©ez le fichier `nextcloud.subdomain.conf`.

```shell
sudo vi /docker/swag/config/nginx/proxy-confs/nexctloud.subdomain.conf
```
Entrez en modification avec la touche `i` et collez la configuration ci-dessous :

```nginx
## Version 2024/04/25
server {
    listen 443 ssl;
    listen [::]:443 ssl;

    server_name nextcloud.*;

    include /config/nginx/ssl.conf;

    client_max_body_size 0;

    location / {
        include /config/nginx/proxy.conf;
        include /config/nginx/resolver.conf;
        set $upstream_app nextcloud;
        set $upstream_port 443;
        set $upstream_proto https;
        proxy_pass $upstream_proto://$upstream_app:$upstream_port;

        # Hide proxy response headers from Nextcloud that conflict with ssl.conf
        # Uncomment the Optional additional headers in SWAG's ssl.conf to pass Nextcloud's security scan
        proxy_hide_header Referrer-Policy;
        proxy_hide_header X-Content-Type-Options;
        proxy_hide_header X-Frame-Options;
        proxy_hide_header X-XSS-Protection;

        # Disable proxy buffering
        proxy_buffering off;
    }
}
```

Appuyez sur `Echap` puis sauvegardez et quittez en tapant `:x` puis en appuyant sur `Entr√©e`.

Et voil√†, vous avez expos√© Nextcloud ! Et n'oubliez pas d'installer [les applications pour ordinateurs et mobiles](https://nextcloud.com/fr/install/).

::alert{type="success"}
‚ú® __Astuce :__ Vous pouvez prot√©ger cette app avec Authentik de fa√ßon native en [suivant ces instructions](https://docs.goauthentik.io/integrations/services/nextcloud/).
::