---
navigation: true
title: Wireguard
main:
  fluid: false
---
:ellipsis{left=0px width=40rem top=10rem blur=140px}
# Wireguard

::alert{type="info"}
üéØ __Objectifs :__
  - Installer Wireguard
  - Configurer les clients
  - Acc√©der au r√©seau s√©curis√©
::

## Introduction
---
L'utilisation d'un VPN permet d'acc√©der √† distance aux ressources locales du serveur sans les exposer sur internet. C'est notamment une mani√®re propre de s√©curiser l'acc√®s √† la console SSH, plutot que d'exposer le port sur internet. C'est pouvoir se connecter √† son r√©seau o√π que l'on soit, de maniere s√©curis√©e, et de faire dialoguer des machines qui sont sur des r√©seaux diff√©rents.

Ici nous utiliserons [Wireguard](https://www.wireguard.com/), un serveur VPN s√©curis√© et tr√®s performant, √† l'aide des conteneurs :

- [wg-easy](https://github.com/wg-easy/wg-easy) pour le serveur, qui propose une interface web tr√®s simple pour controler les connexions et t√©l√©charger les fichiers de conf (notamment par QR code pour les t√©l√©phones)
- [Wireguard](https://docs.linuxserver.io/images/docker-wireguard/?h=wireguard) pour les clients linux

Il existe aussi des clients Windows, MacOS, iOS et Android.

Le principe est le suivant :

- Sur internet, n'importe qui peut contacter n'importe quel box internet et donc essayer de contacter n'importe quel serveur expos√©.
- Votre serveur est sur votre r√©seau local. Il est accessible depuis le r√©seau local mais pas depuis internet, mis √† part les services expos√©s (comme nous l'avons fait avec Dockge). Pour acc√©der aux ressources non expos√©es, vous devez √™tre connect√© sur le meme r√©seau que votre serveur et donc etre chez vous. De plus, vous devez laisser ouvert les ports utilis√©s par vos services √† travers le pare feu de votre serveur.
- Nous souhaitons ici au contraire, depuis n'importe o√π, pouvoir acc√©der de maniere securis√©e aux services non expos√©s sur internet du serveur, comme la console SSH qui permet de se connecter √† la machine par exemple.
- Nous souhaitons aussi acc√©der aux services d'autres serveurs, et par exemple relier de maniere s√©curis√©e deux instances de Dockge pour tout controler depuis la meme interface.

Pour cela nous allons cr√©er un **r√©seau priv√© virtuel**, ou VPN, c'est √† dire un tunnel s√©curis√© auquel personne n'a acc√®s √† part les machines que vous relierez entre elles. Elles feront partie d'un nouveau r√©seau et pourront dialoguer entre elle comme dans un r√©seau local. 

D'autre part, vous pourrez ajouter votre t√©l√©phone, un ordinateur portable ou n'importe quel appareil au r√©seau pour pouvoir utiliser vos ressources depuis vos appareils quotidiens, o√π que vous soyiez.

![picture](/img/serveex/vpn.svg)

Dans cette illustration, la machine 1 est sur deux r√©seaux :

- son r√©seau local (tous les appareils li√©s √† la box, avec une adresse IP du type `192.168.x.x ` donc ici la machine 1 et la machine 2)
- le r√©seau du VPN (tous les appareils reli√©s au VPN, avec une seconde adresse IP du type `10.8.x.x` donc ici la machine 1 et 4)

On peut aussi faire en sorte que les machines reli√©es au r√©seau virtuel partagent les acces √† leur r√©seau local. Ici nous ne le ferons pas, pour des raisons de s√©curit√©, et de complexit√© en terme de sous-r√©seau (si les deux machines distantes ont des machines locales qui utilisent la meme adresse IP locale, par exemple `192.168.1.1`, cela posera des conflits). 

Ainsi, sur le r√©seau virtuel, seules les machines directement reli√©es pourront dialoguer entre elle depuis ce r√©seau. Elles ne pourront pas dialoguer avec une machine situ√©es sur un autre r√©seau local et non reli√©e au VPN.

## C√¥t√© serveur
---
::alert{type="info"}
üìã __A v√©rifier au pr√©alable :__
- V√©rifiez si le port `51820 UDP` estlibre sur votre serveur, et bien rout√© dans le NAT de la box `Source 51820 UDP -> Destination 51820 UDP -> Serveur`. En effet, votre serveur √©tant derri√®re votre box, le port de votre box doit etre joignable et rediriger vers le port de votre serveur connect√© √† votre VPN.
- V√©rifiez aussi que le port `51821 TCP` est libre sur le serveur pour acc√©der √† la web ui.
:: 

::alert{type="warning"}
:::list{type="warning"}
- __Attention__: Si votre IP n'est pas fixe, vous devez avoir un nom de domaine redirigeant vers l'IP √† jour √† l'aide d'un [DynDNS](https://en.wikipedia.org/wiki/Dynamic_DNS). Si votre op√©rateur internet utilise un [CGNAT](https://en.wikipedia.org/wiki/Carrier-grade_NAT), vous √™tes cuit. Vous devrez utiliser un VPS externe pour ce tuto, et y connecter votre serveur comme client.
:::
::

Structure des dossiers

```sh
root
‚îî‚îÄ‚îÄ docker
    ‚îî‚îÄ‚îÄ wg-easy
        ‚îú‚îÄ‚îÄ config
        ‚îÇ   ‚îî‚îÄ‚îÄ etc_wireguard
        ‚îú‚îÄ‚îÄ compose.yaml
        ‚îî‚îÄ‚îÄ .env
```

Ouvrez Dockge, cliquez sur `compose` et nommez la stack `wg_easy`.

Copiez la configuration suivante :

```yaml
---
services:
  wg-easy:
    environment:
      - INSECURE=true
    image: ghcr.io/wg-easy/wg-easy:15
    container_name: wg-easy
    networks:
      wg:
        ipv4_address: 10.42.42.42
        ipv6_address: fdcc:ad94:bacf:61a3::2a
    volumes:
      - ./etc_wireguard:/etc/wireguard
      - /lib/modules:/lib/modules:ro
    ports:
      - "51820:51820/udp"
      - "51821:51821/tcp"
    restart: unless-stopped
    cap_add:
      - NET_ADMIN
      - SYS_MODULE
    sysctls:
      - net.ipv4.ip_forward=1
      - net.ipv4.conf.all.src_valid_mark=1
      - net.ipv6.conf.all.disable_ipv6=0
      - net.ipv6.conf.all.forwarding=1
      - net.ipv6.conf.default.forwarding=1

networks:
  wg:
    driver: bridge
    enable_ipv6: true
    ipam:
      driver: default
      config:
        - subnet: 10.42.42.0/24
        - subnet: fdcc:ad94:bacf:61a3::/64

```
::alert{type="success"}
‚ú® __Astuce :__ 
- Vous pouvez personnaliser le port de wireguard et de la webui au lieu des ports par d√©faut.
- Ajoutez le label de watchtower afin d'automatiser les mises √† jour

    ```yaml
    services
      wg-easy:
        #...
        labels:
          - com.centurylinklabs.watchtower.enable=true
::

Puis d√©ployez la stack et connectez vous via le web en local sur `http://ipduserveur:51821`

::alert{type="danger"}
:::list{type="danger"}
- En cas d'√©chec, v√©rifiez les r√®gles du pare-feu.
:::
::

Une fois connect√©, la webui vous guidera :
- Pour cr√©er votre compte et mot de passe d'acc√®s
- Pour configurer l'host √† utiliser dans les fichiers de conf : utilisez l'IP publique de votre box internet (ou de votre VPS), ou le nom de domaine redirigeant vers l'IP de votre box, le cas √©cheant.

Une fois fait:
- Cliquez sur *¬´ Administrator ¬ª* > *¬´ Admin Panel ¬ª* > *¬´ Config ¬ª*
- Modifiez `Allowed IPs` en rempla√ßant `0.0.0.0/24` par `10.8.0.0/24`. Cela signifie que seules les requ√™tes IP de `10.8.0.1` √† `10.8.0.255` seront redirig√©es dans le tunnel (split tunneling), laissant ainsi √† l'appareil la possibilit√© d'etre connect√© √† d'autres tunnels, et √† acc√©der √† internet par lui meme. Si vous voulez tout rediriger dans le tunnel, y compris l'acces √† internet, laissez `0.0.0.0/24`.
- Supprimez l'IPv6, cela n'apportera que des probl√®mes.

### Recuperation des fichiers de conf

Afin de configurer les clients, vous devez t√©l√©charger les fichiers de conf g√©n√©r√©s par l'host :

- Connectez vous via le web en local sur `http://ipduserveur:51821`
- Cr√©ez un client
- Modifiez le client en cliquant sur l'icone d'√©dition
- Modifiez `Server Allowed IPs` en ajoutant `10.8.0.0/24`. Cela signifie que le serveur laissera vos clients acc√©der √† toutes les IP `10.8.0.1` √† `10.8.0.255` connect√©es √† lui, et donc laissera les clients dialoguer entre eux si n√©cessaire. Si vous voulez laisser vos clients acc√©der √† tous les appareils r√©seau connect√©s autour de votre serveur en local, mettez `0.0.0.0`, √† condition de l'avoir fait pr√©c√©demment dans la configuration g√©n√©rale.
- (facultatif) Si votre client est un serveur qui doit √™tre connect√© en permanence, modifiez `Advanced` > `Persistent Keep Alive` en mettant `25`.
- Sauvegardez
- T√©l√©chargez le fichier de conf
- Renommez le en `wg0.conf`. (Si ce n'est pas le premier, incr√©mentez: `wg1.conf`, etc...)


## Sur le serveur client
---
::alert{type="info"}
:::list{type="info"}
- Nous partons du principe que le serveur client est un serveur linux avec Docker install√©
:::
::

Structure des dossiers

```sh
root
‚îî‚îÄ‚îÄ docker
    ‚îî‚îÄ‚îÄ wireguard
        ‚îî‚îÄ‚îÄ config
        ‚îÇ   ‚îî‚îÄ‚îÄ wg_confs
        ‚îî‚îÄ‚îÄ compose.yaml
```

Creez le dossier `/docker/wireguard/config/wg_confs`.

::alert{type="success"}
‚ú® __Astuce pour les allergiques au terminal :__
vous pouvez utiliser [File Browser](/serveex/files/file-browser) pour naviguer dans vos fichier et √©diter vos documents au lieu d'utiliser les commandes du terminal.
::

```sh
sudo mkdir -p /docker/wireguard/config/wg_confs
```

Cr√©ez le fichier `wg0.conf`

```sh
sudo vi /docker/wireguard/config/wg_confs/wg0.conf
```

Rentrez en √©dition en appuyant sur `i` puis Copiez collez le contenu du `wg0.conf` que vous avez t√©l√©charg√©. Puis sortez du mode √©dition en appuyant sur `Echap` puis tapez `:x`. 


::alert{type="success"}
‚ú® __Astuce :__ Un autre moyen est de transf√©rer le fichier par sftp dans le dossier `/home/nomdutilisateur` puis de le copier dans le bon dossier :

    ```sh
    sudo cp ~/wg0.conf /docker/wireguard/config/wg_confs

::

Creez le `compose.yaml` dans `/docker/wireguard `:
```sh
sudo vi /docker/wireguard/compose.yaml
```
Appuyez sur `i` pour rentrer en modification et copiez la configuration ci-dessous
```yaml
services:
  wireguard:
    image: lscr.io/linuxserver/wireguard:latest
    container_name: wireguard
    network_mode: host
    cap_add:
      - NET_ADMIN
      - SYS_MODULE #optional
    environment:
      - TZ=Europe/Paris
    volumes:
      - /docker/wireguard/config:/config
      - /lib/modules:/lib/modules #optional
    restart: unless-stopped
```

Appuyez sur `Echap` puis tapez `:x` pour quitter et sauvegarder.

Lancez le conteneur :
```sh
cd /docker/wireguard
sudo docker compose up -d
```
::alert{type="info"}
:::list{type="info"}
- A r√©p√©ter pour chaque client
:::
::

## Autres appareils
---
- **T√©l√©phone :** installer wireguard et scanner le QR code via le webui (http://ipduserveur:51821)
- **PC :** Installer wireguard client et mettre directement le fichier de conf t√©l√©charg√© via le webui

::alert{type="warning"}
:::list{type="warning"}
- __Attention :__ Si des machines clientes sont sur le meme r√©seau local que le serveur (derriere la box), √©ditez le fichier `wg0.conf` upload√© sur cette machine en changeant avec l'adresse locale du serveur : `Endpoint = ipduserveur:51820`{lang=properties}
:::
::

Et voil√† ce que cela peut donner !

![picture](/img/serveex/wireguard.svg)