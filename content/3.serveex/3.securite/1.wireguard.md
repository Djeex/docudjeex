---
navigation: true
title: Wireguard
main:
  fluid: false
---
:ellipsis{left=0px width=40rem top=10rem blur=140px}
# Wireguard

::alert{type="info"}
üéØ __Objectifs :__
  - Installer Wireguard
  - Configurer les clients
  - Acc√©der au r√©seau s√©curis√©
::

## Introduction
---
L'utilisation d'un VPN permet d'acc√©der √† distance aux ressources locales du serveur sans les exposer sur internet. C'est notamment une mani√®re propre de s√©curiser l'acc√®s √† la console SSH, plutot que d'exposer le port sur internet. C'est pouvoir se connecter √† son r√©seau o√π que l'on soit, de maniere s√©curis√©e, et de faire dialoguer des machines qui sont sur des r√©seaux diff√©rents.

Ici nous utiliserons [Wireguard](https://www.wireguard.com/), un serveur VPN s√©curis√© et tr√®s performant, √† l'aide des conteneurs :

- [wg-easy](https://github.com/wg-easy/wg-easy) pour le serveur, qui propose une interface web tr√®s simple pour controler les connexions et t√©l√©charger les fichiers de conf (notamment par QR code pour les t√©l√©phones)
- [Wireguard](https://docs.linuxserver.io/images/docker-wireguard/?h=wireguard) pour les clients linux

Il existe aussi des clients Windows, MacOS, iOS et Android.

Le principe est le suivant :

- Sur internet, n'importe qui peut contacter n'importe quel box internet et donc essayer de contacter n'importe quel serveur expos√©.
- Votre serveur est sur votre r√©seau local. Il est accessible depuis le r√©seau local mais pas depuis internet, mis √† part les services expos√©s (comme nous l'avons fait avec Dockge). Pour acc√©der aux ressources non expos√©es, vous devez √™tre connect√© sur le meme r√©seau que votre serveur et donc etre chez vous. De plus, vous devez laisser ouvert les ports utilis√©s par vos services √† travers le pare feu de votre serveur.
- Nous souhaitons ici au contraire, depuis n'importe o√π, pouvoir acc√©der de maniere securis√©e aux services non expos√©s sur internet du serveur, comme la console SSH qui permet de se connecter √† la machine par exemple.
- Nous souhaitons aussi acc√©der aux services d'autres serveurs, et par exemple relier de maniere s√©curis√©e deux instances de Dockge pour tout controler depuis la meme interface.

Pour cela nous allons cr√©er un **r√©seau priv√© virtuel**, ou VPN, c'est √† dire un tunnel s√©curis√© auquel personne n'a acc√®s √† part les machines que vous relierez entre elles. Elles feront partie d'un nouveau r√©seau et pourront dialoguer entre elle comme dans un r√©seau local. 

D'autre part, vous pourrez ajouter votre t√©l√©phone, un ordinateur portable ou n'importe quel appareil au r√©seau pour pouvoir utiliser vos ressources depuis vos appareils quotidiens, o√π que vous soyiez.

![picture](/img/serveex/vpn.svg)

Dans cette illustration, la machine 1 est sur deux r√©seaux :

- son r√©seau local (tous les appareils li√©s √† la box, avec une adresse IP du type `192.168.x.x ` donc ici la machine 1 et la machine 2)
- le r√©seau du VPN (tous les appareils reli√©s au VPN, avec une seconde adresse IP du type `10.8.x.x` donc ici la machine 1 et 4)

On peut aussi faire en sorte que les machines reli√©es au r√©seau virtuel partagent les acces √† leur r√©seau local. Ici nous ne le ferons pas, pour des raisons de s√©curit√©, et de complexit√© en terme de sous-r√©seau (si les deux machines distantes ont des machines locales qui utilisent la meme adresse IP locale, par exemple `192.168.1.1`, cela posera des conflits). 

Ainsi, sur le r√©seau virtuel, seules les machines directement reli√©es pourront dialoguer entre elle depuis ce r√©seau. Elles ne pourront pas dialoguer avec une machine situ√©es sur un autre r√©seau local et non reli√©e au VPN.

## C√¥t√© serveur
---
::alert{type="info"}
üìã __A v√©rifier au pr√©alable :__
- V√©rifiez si le port `51820 UDP` estlibre sur votre serveur, et bien rout√© dans le NAT de la box `Source 51820 UDP -> Destination 51820 UDP -> Serveur`. En effet, votre serveur √©tant derri√®re votre box, le port de votre box doit etre joignable et rediriger vers le port de votre serveur connect√© √† votre VPN.
- V√©rifiez aussi que le port `51821 TCP` est libre sur le serveur pour acc√©der √† la web ui.
:: 

::alert{type="warning"}
:::list{type="warning"}
- __Attention :__ Cette documentation utilise la version `14` de [wg-easy](https://wg-easy.github.io/wg-easy/latest/). La version `15`comporte des breaking changes qui ne sont pas compatibles avec les configurations propos√©es ici.
:::
::

Structure des dossiers

```console
root
‚îî‚îÄ‚îÄ docker
    ‚îî‚îÄ‚îÄ wg-easy
        ‚îú‚îÄ‚îÄ config
        ‚îÇ   ‚îî‚îÄ‚îÄ etc_wireguard
        ‚îú‚îÄ‚îÄ compose.yaml
        ‚îî‚îÄ‚îÄ .env
```

Le conteneur sera en mode `HOST`, c'est √† dire qu'il occupera les ports de votre host comme s'il n'etait pas dans un conteneur mais directement install√© sur la machine, sans passer par un sous-r√©seau.

Ouvrez Dockge, cliquez sur `compose` et nommez la stack `wg_easy`.

Copiez la configuration suivante :

```yaml
---
services:
  wg-easy:
    network_mode: host
    env_file:
      - .env
    environment:
      - LANG=en
      - WG_HOST=${HOST}
      - PASSWORD_HASH=${PW}
      - WG_DEFAULT_ADDRESS=${ADDRESS}
      - WG_HIDE_KEYS=never
      - WG_ALLOWED_IPS=${IPS}
      - WG_DEFAULT_DNS=
      - UI_TRAFFIC_STATS=true
      - UI_CHART_TYPE=1
    image: ghcr.io/wg-easy/wg-easy:14
    container_name: wg-easy
    volumes:
      - /docker/wg_easy/config/etc_wireguard:/etc/wireguard
    restart: unless-stopped
    cap_add:
      - NET_ADMIN
      - SYS_MODULE
```
::alert{type="success"}
‚ú® __Astuce :__ 
- Vous pouvez personnaliser le port de wireguard avec `WG_PORT` au lieu du port par defaut `51820`
- Ajoutez le label de watchtower afin d'automatiser les mises √† jour

    ```yaml
    services
      wg-easy:
        #...
        labels:
          - com.centurylinklabs.watchtower.enable=true
::

Dans  `.env` :

```properties
HOST=
PW=
ADDRESS=
IPS=
```

| Variable                  | Valeur                                                                                                                                                                                                                                                                                                                                                                                                                                    | Exemples      |
|---------------------------|-------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------|---------------|
| `HOST`{lang=properties}    | IP publique de votre box internet (elle doit etre fixe)                                                                                                                                                                                                                                                                                                                                                                                                                        | `80.72.136.27` |
| `PW`{lang=properties}      | Hash du mot de passe, [√† g√©n√©rer ici](https://bcrypt-generator.com/). **ATTENTION:** doubler les `$`                                                                                                                                                                                                                                                                                                                                                                      | `$$2a$$12$$FF6T4QqSP9Ho`|
| `ADDRESS`{lang=properties} | Plage d'adresse que le DHCP du VPN peut attribuer, le `x` doit etre pr√©sent, on peut changer les autres chiffres ou les remplacer par `x` aussi                                                                                                                                                                                                                                                                                           | `10.8.0.x`      |
| `IPS`{lang=properties}     | les IPs qui doivent etre rout√©es par les clients vers le VPN. Dans notre cas, on veut que seul le traffic vers le serveur et clients du VPN soit rout√©, on veut pas de leurs r√©seau local et on veut conserver l'acc√®s √† internet direct sans passer par le VPN.Si vous voulez tout de meme ajouter toutes les machines connect√©es aux appareils en local, ajoutez la plage `192.168.0.0/16` en s√©parant les deux plages par une virgule. | `10.8.0.0/24`   |


Puis d√©ployez la stack.

### Activation du forwarding depuis l'host

Pour que l'host autorise les clients √† communiquer entre eux, vous devez activer les param√®ttres suivants :

```shell
sudo sysctl net.ipv4.ip_forward=1
sudo sysctl net.ipv4.conf.all.src_valid_mark=1
```

### Recuperation des fichiers de conf

Afin de configurer les clients, vous devez t√©l√©charger les fichiers de conf g√©n√©r√©s par l'host :

- Connectez vous via le web en local sur `http://ipduserveur:51821`
- Cr√©ez un client
- T√©l√©chargez le fichier de conf
- Renommez le en `wg0.conf`

::alert{type="danger"}
:::list{type="danger"}
- En cas d'√©chec, v√©rifiez les r√®gles du pare-feu.
:::
::

## Sur le serveur client
---
::alert{type="info"}
:::list{type="info"}
- Nous partons du principe que le serveur client est un serveur linux avec Docker install√©
:::
::

Structure des dossiers

```console
root
‚îî‚îÄ‚îÄ docker
    ‚îî‚îÄ‚îÄ wireguard
        ‚îî‚îÄ‚îÄ config
        ‚îÇ   ‚îî‚îÄ‚îÄ wg_confs
        ‚îî‚îÄ‚îÄ compose.yaml
```

Creez le dossier `/docker/wireguard/config/wg_confs`.

::alert{type="success"}
‚ú® __Astuce pour les allergiques au terminal :__
vous pouvez utiliser [File Browser](/serveex/files/file-browser) pour naviguer dans vos fichier et √©diter vos documents au lieu d'utiliser les commandes du terminal.
::

```shell
sudo mkdir -p /docker/wireguard/config/wg_confs
```

Copiez le fichier` wg0.conf` t√©l√©charg√© pr√©c√©demment. 

::alert{type="success"}
‚ú® __Astuce :__ Le moyen le plus simple est de transf√©rer le fichier par sftp dans le dossier `/home/nomdutilisateur` puis de le copier dans le bon dossier :

    ```shell
    sudo cp ~/wg0.conf /docker/wireguard/config/wg_confs

::

Creez le `compose.yaml` dans `/docker/wireguard `:
```shell
sudo vi /docker/wireguard/compose.yaml
```
Appuyez sur `i` pour rentrer en modification et copiez la configuration ci-dessous
```yaml
services:
  wireguard:
    image: lscr.io/linuxserver/wireguard:latest
    container_name: wireguard
    network_mode: host
    cap_add:
      - NET_ADMIN
      - SYS_MODULE #optional
    environment:
      - TZ=Europe/Paris
    volumes:
      - /docker/wireguard/config:/config
      - /lib/modules:/lib/modules #optional
    restart: unless-stopped
```

Appuyez sur `Echap` puis tapez `:x` pour quitter et sauvegarder.

Lancez le conteneur :
```shell
cd /docker/wireguard
sudo docker compose up -d
```
::alert{type="info" icon="exclamation-circle"}
:::list{type="info"}
- A r√©p√©ter pour chaque client
:::
::

## Autres appareils
---
- **T√©l√©phone :** installer wireguard et scanner le QR code via le webui (http://ipduserveur:51821)
- **PC :** Installer wireguard client et mettre directement le fichier de conf t√©l√©charg√© via le webui

::alert{type="warning"}
:::list{type="warning"}
- __Attention :__ Si des machines clientes sont sur le meme r√©seau local que le serveur (derriere la box), √©ditez le fichier `wg0.conf` upload√© sur cette machine en changeant avec l'adresse locale du serveur : `Endpoint = ipduserveur:51820`{lang=properties}
:::
::

Et voil√† ce que cela peut donner !

![picture](/img/serveex/wireguard.svg)