---
navigation: true
title: Wireguard
main:
  fluid: false
---
:ellipsis{left=0px width=40rem top=10rem blur=140px}
# Wireguard

::alert{type="info"}
ðŸŽ¯ __Objectifs :__
  - Installer Wireguard
  - Configurer les clients
  - AccÃ©der au rÃ©seau sÃ©curisÃ©
::

## Introduction
---
L'utilisation d'un VPN permet d'accÃ©der Ã  distance aux ressources locales du serveur sans les exposer sur internet. C'est notamment une maniÃ¨re propre de sÃ©curiser l'accÃ¨s Ã  la console SSH, plutot que d'exposer le port sur internet. C'est pouvoir se connecter Ã  son rÃ©seau oÃ¹ que l'on soit, de maniere sÃ©curisÃ©e, et de faire dialoguer des machines qui sont sur des rÃ©seaux diffÃ©rents.

Ici nous utiliserons [Wireguard](https://www.wireguard.com/), un serveur VPN sÃ©curisÃ© et trÃ¨s performant, Ã  l'aide des conteneurs :

- [wg-easy](https://github.com/wg-easy/wg-easy) pour le serveur, qui propose une interface web trÃ¨s simple pour controler les connexions et tÃ©lÃ©charger les fichiers de conf (notamment par QR code pour les tÃ©lÃ©phones)
- [Wireguard](https://docs.linuxserver.io/images/docker-wireguard/?h=wireguard) pour les clients linux

Il existe aussi des clients Windows, MacOS, iOS et Android.

Le principe est le suivant :

- Sur internet, n'importe qui peut contacter n'importe quel box internet et donc essayer de contacter n'importe quel serveur exposÃ©.
- Votre serveur est sur votre rÃ©seau local. Il est accessible depuis le rÃ©seau local mais pas depuis internet, mis Ã  part les services exposÃ©s (comme nous l'avons fait avec Dockge). Pour accÃ©der aux ressources non exposÃ©es, vous devez Ãªtre connectÃ© sur le meme rÃ©seau que votre serveur et donc etre chez vous. De plus, vous devez laisser ouvert les ports utilisÃ©s par vos services Ã  travers le pare feu de votre serveur.
- Nous souhaitons ici au contraire, depuis n'importe oÃ¹, pouvoir accÃ©der de maniere securisÃ©e aux services non exposÃ©s sur internet du serveur, comme la console SSH qui permet de se connecter Ã  la machine par exemple.
- Nous souhaitons aussi accÃ©der aux services d'autres serveurs, et par exemple relier de maniere sÃ©curisÃ©e deux instances de Dockge pour tout controler depuis la meme interface.

Pour cela nous allons crÃ©er un **rÃ©seau privÃ© virtuel**, ou VPN, c'est Ã  dire un tunnel sÃ©curisÃ© auquel personne n'a accÃ¨s Ã  part les machines que vous relierez entre elles. Elles feront partie d'un nouveau rÃ©seau et pourront dialoguer entre elle comme dans un rÃ©seau local. 

D'autre part, vous pourrez ajouter votre tÃ©lÃ©phone, un ordinateur portable ou n'importe quel appareil au rÃ©seau pour pouvoir utiliser vos ressources depuis vos appareils quotidiens, oÃ¹ que vous soyiez.

![picture](/img/serveex/vpn.svg)

Dans cette illustration, la machine 1 est sur deux rÃ©seaux :

- son rÃ©seau local (tous les appareils liÃ©s Ã  la box, avec une adresse IP du type `192.168.x.x ` donc ici la machine 1 et la machine 2)
- le rÃ©seau du VPN (tous les appareils reliÃ©s au VPN, avec une seconde adresse IP du type `10.8.x.x` donc ici la machine 1 et 4)

On peut aussi faire en sorte que les machines reliÃ©es au rÃ©seau virtuel partagent les acces Ã  leur rÃ©seau local. Ici nous ne le ferons pas, pour des raisons de sÃ©curitÃ©, et de complexitÃ© en terme de sous-rÃ©seau (si les deux machines distantes ont des machines locales qui utilisent la meme adresse IP locale, par exemple `192.168.1.1`, cela posera des conflits). 

Ainsi, sur le rÃ©seau virtuel, seules les machines directement reliÃ©es pourront dialoguer entre elle depuis ce rÃ©seau. Elles ne pourront pas dialoguer avec une machine situÃ©es sur un autre rÃ©seau local et non reliÃ©e au VPN.

## CÃ´tÃ© serveur
---
::alert{type="info"}
ðŸ“‹ __A vÃ©rifier au prÃ©alable :__
- VÃ©rifiez si le port `51820 UDP` estlibre sur votre serveur, et bien routÃ© dans le NAT de la box `Source 51820 UDP -> Destination 51820 UDP -> Serveur`. En effet, votre serveur Ã©tant derriÃ¨re votre box, le port de votre box doit etre joignable et rediriger vers le port de votre serveur connectÃ© Ã  votre VPN.
- VÃ©rifiez aussi que le port `51821 TCP` est libre sur le serveur pour accÃ©der Ã  la web ui.
:: 

::alert{type="warning"}
:::list{type="warning"}
- __Attention__: Si votre IP n'est pas fixe, vous devez avoir un nom de domaine redirigeant vers l'IP Ã  jour Ã  l'aide d'un [DynDNS](https://en.wikipedia.org/wiki/Dynamic_DNS). Si votre opÃ©rateur internet utilise un [CGNAT](https://en.wikipedia.org/wiki/Carrier-grade_NAT), vous Ãªtes cuit. Vous devrez utiliser un VPS externe pour ce tuto, et y connecter votre serveur comme client.
:::
::

Structure des dossiers

```sh
root
â””â”€â”€ docker
    â””â”€â”€ wg-easy
        â”œâ”€â”€ config
        â”‚   â””â”€â”€ etc_wireguard
        â”œâ”€â”€ compose.yaml
        â””â”€â”€ .env
```

Ouvrez Dockge, cliquez sur `compose` et nommez la stack `wg_easy`.

Copiez la configuration suivante :

```yaml
---
services:
  wg-easy:
    environment:
      - INSECURE=true
    image: ghcr.io/wg-easy/wg-easy:15
    container_name: wg-easy
    networks:
      wg:
        ipv4_address: 10.42.42.42
        ipv6_address: fdcc:ad94:bacf:61a3::2a
    volumes:
      - ./etc_wireguard:/etc/wireguard
      - /lib/modules:/lib/modules:ro
    ports:
      - "51820:51820/udp"
      - "51821:51821/tcp"
    restart: unless-stopped
    cap_add:
      - NET_ADMIN
      - SYS_MODULE
    sysctls:
      - net.ipv4.ip_forward=1
      - net.ipv4.conf.all.src_valid_mark=1
      - net.ipv6.conf.all.disable_ipv6=0
      - net.ipv6.conf.all.forwarding=1
      - net.ipv6.conf.default.forwarding=1

networks:
  wg:
    driver: bridge
    enable_ipv6: true
    ipam:
      driver: default
      config:
        - subnet: 10.42.42.0/24
        - subnet: fdcc:ad94:bacf:61a3::/64

```
::alert{type="success"}
âœ¨ __Astuce :__ 
- Vous pouvez personnaliser le port de wireguard et de la webui au lieu des ports par dÃ©faut.
- Ajoutez le label de watchtower afin d'automatiser les mises Ã  jour

    ```yaml
    services
      wg-easy:
        #...
        labels:
          - com.centurylinklabs.watchtower.enable=true
::

Puis dÃ©ployez la stack et connectez vous via le web en local sur `http://ipduserveur:51821`

::alert{type="danger"}
:::list{type="danger"}
- En cas d'Ã©chec, vÃ©rifiez les rÃ¨gles du pare-feu.
:::
::

Une fois connectÃ©, la webui vous guidera :
- Pour crÃ©er votre compte et mot de passe d'accÃ¨s
- Pour configurer l'host Ã  utiliser dans les fichiers de conf : utilisez l'IP publique de votre box internet (ou de votre VPS), ou le nom de domaine redirigeant vers l'IP de votre box, le cas Ã©cheant.

Une fois fait:
- Cliquez sur *Â« Administrator Â»* > *Â« Admin Panel Â»* > *Â« Config Â»*
- Modifiez `Allowed IPs` en remplaÃ§ant `0.0.0.0/24` par `10.8.0.0/24`. Cela signifie que seules les requÃªtes IP de `10.8.0.1` Ã  `10.8.0.255` seront redirigÃ©es dans le tunnel (split tunneling), laissant ainsi Ã  l'appareil la possibilitÃ© d'etre connectÃ© Ã  d'autres tunnels, et Ã  accÃ©der Ã  internet par lui meme. Si vous voulez tout rediriger dans le tunnel, y compris l'acces Ã  internet, laissez `0.0.0.0/24`.
- Supprimez l'IPv6, cela n'apportera que des problÃ¨mes.

### Recuperation des fichiers de conf

Afin de configurer les clients, vous devez tÃ©lÃ©charger les fichiers de conf gÃ©nÃ©rÃ©s par l'host :

- Connectez vous via le web en local sur `http://ipduserveur:51821`
- CrÃ©ez un client
- Modifiez le client en cliquant sur l'icone d'Ã©dition
- Modifiez `Server Allowed IPs` en ajoutant `10.8.0.0/24`. Cela signifie que le serveur laissera vos clients accÃ©der Ã  toutes les IP `10.8.0.1` Ã  `10.8.0.255` connectÃ©es Ã  lui, et donc laissera les clients dialoguer entre eux si nÃ©cessaire. Si vous voulez laisser vos clients accÃ©der Ã  tous les appareils rÃ©seau connectÃ©s autour de votre serveur en local, mettez `0.0.0.0`, Ã  condition de l'avoir fait prÃ©cÃ©demment dans la configuration gÃ©nÃ©rale.
- (facultatif) Si votre client est un serveur qui doit Ãªtre connectÃ© en permanence, modifiez `Advanced` > `Persistent Keep Alive` en mettant `25`.
- Sauvegardez
- TÃ©lÃ©chargez le fichier de conf
- Renommez le en `wg0.conf`. (Si ce n'est pas le premier, incrÃ©mentez: `wg1.conf`, etc...)


## Sur le serveur client
---
::alert{type="info"}
:::list{type="info"}
- Nous partons du principe que le serveur client est un serveur linux avec Docker installÃ©
:::
::

Structure des dossiers

```sh
root
â””â”€â”€ docker
    â””â”€â”€ wireguard
        â””â”€â”€ config
        â”‚   â””â”€â”€ wg_confs
        â””â”€â”€ compose.yaml
```

Creez le dossier `/docker/wireguard/config/wg_confs`.

::alert{type="success"}
âœ¨ __Astuce pour les allergiques au terminal :__
vous pouvez utiliser [File Browser](/serveex/files/file-browser) pour naviguer dans vos fichier et Ã©diter vos documents au lieu d'utiliser les commandes du terminal.
::

```sh
sudo mkdir -p /docker/wireguard/config/wg_confs
```

CrÃ©ez le fichier `wg0.conf`

```sh
sudo vi /docker/wireguard/config/wg_confs/wg0.conf
```

Rentrez en Ã©dition en appuyant sur `i` puis Copiez collez le contenu du `wg0.conf` que vous avez tÃ©lÃ©chargÃ©. Puis sortez du mode Ã©dition en appuyant sur `Echap` puis tapez `:x`. 


::alert{type="success"}
âœ¨ __Astuce :__ Un autre moyen est de transfÃ©rer le fichier par sftp dans le dossier `/home/nomdutilisateur` puis de le copier dans le bon dossier :

    ```sh
    sudo cp ~/wg0.conf /docker/wireguard/config/wg_confs

::

Creez le `compose.yaml` dans `/docker/wireguard `:
```sh
sudo vi /docker/wireguard/compose.yaml
```
Appuyez sur `i` pour rentrer en modification et copiez la configuration ci-dessous
```yaml
services:
  wireguard:
    image: lscr.io/linuxserver/wireguard:latest
    container_name: wireguard
    network_mode: host
    cap_add:
      - NET_ADMIN
      - SYS_MODULE #optional
    environment:
      - TZ=Europe/Paris
    volumes:
      - /docker/wireguard/config:/config
      - /lib/modules:/lib/modules #optional
    restart: unless-stopped
```

Appuyez sur `Echap` puis tapez `:x` pour quitter et sauvegarder.

Lancez le conteneur :
```sh
cd /docker/wireguard
sudo docker compose up -d
```
::alert{type="info"}
:::list{type="info"}
- A rÃ©pÃ©ter pour chaque client
:::
::

## Autres appareils
---
- **TÃ©lÃ©phone :** installer wireguard et scanner le QR code via le webui (http://ipduserveur:51821)
- **PC :** Installer wireguard client et mettre directement le fichier de conf tÃ©lÃ©chargÃ© via le webui

::alert{type="warning"}
:::list{type="warning"}
- __Attention :__ Si des machines clientes sont sur le meme rÃ©seau local que le serveur (derriere la box), Ã©ditez le fichier `wg0.conf` uploadÃ© sur cette machine en changeant avec l'adresse locale du serveur : `Endpoint = ipduserveur:51820`{lang=properties}
:::
::

Et voilÃ  ce que cela peut donner !

![picture](/img/serveex/wireguard.svg)