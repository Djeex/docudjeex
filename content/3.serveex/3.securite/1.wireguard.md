---
navigation: true
title: Wireguard
main:
  fluid: false
---
:ellipsis{left=0px width=40rem top=10rem blur=140px}
# Wireguard

::alert{type="info"}
ðŸŽ¯ __Objectifs :__
  - Installer Wireguard
  - Configurer les clients
  - AccÃ©der au rÃ©seau sÃ©curisÃ©
::

## Introduction
---
L'utilisation d'un VPN permet d'accÃ©der Ã  distance aux ressources locales du serveur sans les exposer sur internet. C'est notamment une maniÃ¨re propre de sÃ©curiser l'accÃ¨s Ã  la console SSH, plutot que d'exposer le port sur internet. C'est pouvoir se connecter Ã  son rÃ©seau oÃ¹ que l'on soit, de maniere sÃ©curisÃ©e, et de faire dialoguer des machines qui sont sur des rÃ©seaux diffÃ©rents.

Ici nous utiliserons [Wireguard](https://www.wireguard.com/), un serveur VPN sÃ©curisÃ© et trÃ¨s performant, Ã  l'aide des conteneurs :

- [wg-easy](https://github.com/wg-easy/wg-easy) pour le serveur, qui propose une interface web trÃ¨s simple pour controler les connexions et tÃ©lÃ©charger les fichiers de conf (notamment par QR code pour les tÃ©lÃ©phones)
- [Wireguard](https://docs.linuxserver.io/images/docker-wireguard/?h=wireguard) pour les clients linux

Il existe aussi des clients Windows, MacOS, iOS et Android.

Le principe est le suivant :

- Sur internet, n'importe qui peut contacter n'importe quel box internet et donc essayer de contacter n'importe quel serveur exposÃ©.
- Votre serveur est sur votre rÃ©seau local. Il est accessible depuis le rÃ©seau local mais pas depuis internet, mis Ã  part les services exposÃ©s (comme nous l'avons fait avec Dockge). Pour accÃ©der aux ressources non exposÃ©es, vous devez Ãªtre connectÃ© sur le meme rÃ©seau que votre serveur et donc etre chez vous. De plus, vous devez laisser ouvert les ports utilisÃ©s par vos services Ã  travers le pare feu de votre serveur.
- Nous souhaitons ici au contraire, depuis n'importe oÃ¹, pouvoir accÃ©der de maniere securisÃ©e aux services non exposÃ©s sur internet du serveur, comme la console SSH qui permet de se connecter Ã  la machine par exemple.
- Nous souhaitons aussi accÃ©der aux services d'autres serveurs, et par exemple relier de maniere sÃ©curisÃ©e deux instances de Dockge pour tout controler depuis la meme interface.

Pour cela nous allons crÃ©er un **rÃ©seau privÃ© virtuel**, ou VPN, c'est Ã  dire un tunnel sÃ©curisÃ© auquel personne n'a accÃ¨s Ã  part les machines que vous relierez entre elles. Elles feront partie d'un nouveau rÃ©seau et pourront dialoguer entre elle comme dans un rÃ©seau local. 

D'autre part, vous pourrez ajouter votre tÃ©lÃ©phone, un ordinateur portable ou n'importe quel appareil au rÃ©seau pour pouvoir utiliser vos ressources depuis vos appareils quotidiens, oÃ¹ que vous soyiez.

![picture](/img/serveex/vpn.svg)

Dans cette illustration, la machine 1 est sur deux rÃ©seaux :

- son rÃ©seau local (tous les appareils liÃ©s Ã  la box, avec une adresse IP du type `192.168.x.x ` donc ici la machine 1 et la machine 2)
- le rÃ©seau du VPN (tous les appareils reliÃ©s au VPN, avec une seconde adresse IP du type `10.8.x.x` donc ici la machine 1 et 4)

On peut aussi faire en sorte que les machines reliÃ©es au rÃ©seau virtuel partagent les acces Ã  leur rÃ©seau local. Ici nous ne le ferons pas, pour des raisons de sÃ©curitÃ©, et de complexitÃ© en terme de sous-rÃ©seau (si les deux machines distantes ont des machines locales qui utilisent la meme adresse IP locale, par exemple `192.168.1.1`, cela posera des conflits). 

Ainsi, sur le rÃ©seau virtuel, seules les machines directement reliÃ©es pourront dialoguer entre elle depuis ce rÃ©seau. Elles ne pourront pas dialoguer avec une machine situÃ©es sur un autre rÃ©seau local et non reliÃ©e au VPN.

## CÃ´tÃ© serveur
---
::alert{type="info"}
ðŸ“‹ __A vÃ©rifier au prÃ©alable :__
- VÃ©rifiez si le port `51820 UDP` estlibre sur votre serveur, et bien routÃ© dans le NAT de la box `Source 51820 UDP -> Destination 51820 UDP -> Serveur`. En effet, votre serveur Ã©tant derriÃ¨re votre box, le port de votre box doit etre joignable et rediriger vers le port de votre serveur connectÃ© Ã  votre VPN.
- VÃ©rifiez aussi que le port `51821 TCP` est libre sur le serveur pour accÃ©der Ã  la web ui.
:: 

::alert{type="warning"}
:::list{type="warning"}
- __Attention :__ Cette documentation utilise la version `14` de [wg-easy](https://wg-easy.github.io/wg-easy/latest/). La version `15`comporte des breaking changes qui ne sont pas compatibles avec les configurations proposÃ©es ici.
:::
::

Structure des dossiers

```console
root
â””â”€â”€ docker
    â””â”€â”€ wg-easy
        â”œâ”€â”€ config
        â”‚   â””â”€â”€ etc_wireguard
        â”œâ”€â”€ compose.yaml
        â””â”€â”€ .env
```

Le conteneur sera en mode `HOST`, c'est Ã  dire qu'il occupera les ports de votre host comme s'il n'etait pas dans un conteneur mais directement installÃ© sur la machine, sans passer par un sous-rÃ©seau.

Ouvrez Dockge, cliquez sur `compose` et nommez la stack `wg_easy`.

Copiez la configuration suivante :

```yaml
---
services:
  wg-easy:
    network_mode: host
    env_file:
      - .env
    environment:
      - LANG=en
      - WG_HOST=${HOST}
      - PASSWORD_HASH=${PW}
      - WG_DEFAULT_ADDRESS=${ADDRESS}
      - WG_HIDE_KEYS=never
      - WG_ALLOWED_IPS=${IPS}
      - WG_DEFAULT_DNS=
      - UI_TRAFFIC_STATS=true
      - UI_CHART_TYPE=1
    image: ghcr.io/wg-easy/wg-easy:14
    container_name: wg-easy
    volumes:
      - /docker/wg_easy/config/etc_wireguard:/etc/wireguard
    restart: unless-stopped
    cap_add:
      - NET_ADMIN
      - SYS_MODULE
```
::alert{type="success"}
âœ¨ __Astuce :__ 
- Vous pouvez personnaliser le port de wireguard avec `WG_PORT` au lieu du port par defaut `51820`
- Ajoutez le label de watchtower afin d'automatiser les mises Ã  jour

    ```yaml
    services
      wg-easy:
        #...
        labels:
          - com.centurylinklabs.watchtower.enable=true
::

Dans  `.env` :

```properties
HOST=
PW=
ADDRESS=
IPS=
```

| Variable                  | Valeur                                                                                                                                                                                                                                                                                                                                                                                                                                    | Exemples      |
|---------------------------|-------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------|---------------|
| `HOST`{lang=properties}    | IP publique de votre box internet (elle doit etre fixe)                                                                                                                                                                                                                                                                                                                                                                                                                        | `80.72.136.27` |
| `PW`{lang=properties}      | Hash du mot de passe, [Ã  gÃ©nÃ©rer ici](https://bcrypt-generator.com/). **ATTENTION:** doubler les `$`                                                                                                                                                                                                                                                                                                                                                                      | `$$2a$$12$$FF6T4QqSP9Ho`|
| `ADDRESS`{lang=properties} | Plage d'adresse que le DHCP du VPN peut attribuer, le `x` doit etre prÃ©sent, on peut changer les autres chiffres ou les remplacer par `x` aussi                                                                                                                                                                                                                                                                                           | `10.8.0.x`      |
| `IPS`{lang=properties}     | les IPs qui doivent etre routÃ©es par les clients vers le VPN. Dans notre cas, on veut que seul le traffic vers le serveur et clients du VPN soit routÃ©, on veut pas de leurs rÃ©seau local et on veut conserver l'accÃ¨s Ã  internet direct sans passer par le VPN.Si vous voulez tout de meme ajouter toutes les machines connectÃ©es aux appareils en local, ajoutez la plage `192.168.0.0/16` en sÃ©parant les deux plages par une virgule. | `10.8.0.0/24`   |


Puis dÃ©ployez la stack.

### Activation du forwarding depuis l'host

Pour que l'host autorise les clients Ã  communiquer entre eux, vous devez activer les paramÃ¨ttres suivants :

```shell
sudo sysctl net.ipv4.ip_forward=1
sudo sysctl net.ipv4.conf.all.src_valid_mark=1
```

### Recuperation des fichiers de conf

Afin de configurer les clients, vous devez tÃ©lÃ©charger les fichiers de conf gÃ©nÃ©rÃ©s par l'host :

- Connectez vous via le web en local sur `http://ipduserveur:51821`
- CrÃ©ez un client
- TÃ©lÃ©chargez le fichier de conf
- Renommez le en `wg0.conf`

::alert{type="danger"}
:::list{type="danger"}
- En cas d'Ã©chec, vÃ©rifiez les rÃ¨gles du pare-feu.
:::
::

## Sur le serveur client
---
::alert{type="info"}
:::list{type="info"}
- Nous partons du principe que le serveur client est un serveur linux avec Docker installÃ©
:::
::

Structure des dossiers

```console
root
â””â”€â”€ docker
    â””â”€â”€ wireguard
        â””â”€â”€ config
        â”‚   â””â”€â”€ wg_confs
        â””â”€â”€ compose.yaml
```

Creez le dossier `/docker/wireguard/config/wg_confs`.

::alert{type="success"}
âœ¨ __Astuce pour les allergiques au terminal :__
vous pouvez utiliser [File Browser](/serveex/files/file-browser) pour naviguer dans vos fichier et Ã©diter vos documents au lieu d'utiliser les commandes du terminal.
::

```shell
sudo mkdir -p /docker/wireguard/config/wg_confs
```

Copiez le fichier` wg0.conf` tÃ©lÃ©chargÃ© prÃ©cÃ©demment. 

::alert{type="success"}
âœ¨ __Astuce :__ Le moyen le plus simple est de transfÃ©rer le fichier par sftp dans le dossier `/home/nomdutilisateur` puis de le copier dans le bon dossier :

    ```shell
    sudo cp ~/wg0.conf /docker/wireguard/config/wg_confs

::

Creez le `compose.yaml` dans `/docker/wireguard `:
```shell
sudo vi /docker/wireguard/compose.yaml
```
Appuyez sur `i` pour rentrer en modification et copiez la configuration ci-dessous
```yaml
services:
  wireguard:
    image: lscr.io/linuxserver/wireguard:latest
    container_name: wireguard
    network_mode: host
    cap_add:
      - NET_ADMIN
      - SYS_MODULE #optional
    environment:
      - TZ=Europe/Paris
    volumes:
      - /docker/wireguard/config:/config
      - /lib/modules:/lib/modules #optional
    restart: unless-stopped
```

Appuyez sur `Echap` puis tapez `:x` pour quitter et sauvegarder.

Lancez le conteneur :
```shell
cd /docker/wireguard
sudo docker compose up -d
```
::alert{type="info" icon="exclamation-circle"}
:::list{type="info"}
- A rÃ©pÃ©ter pour chaque client
:::
::

## Autres appareils
---
- **TÃ©lÃ©phone :** installer wireguard et scanner le QR code via le webui (http://ipduserveur:51821)
- **PC :** Installer wireguard client et mettre directement le fichier de conf tÃ©lÃ©chargÃ© via le webui

::alert{type="warning"}
:::list{type="warning"}
- __Attention :__ Si des machines clientes sont sur le meme rÃ©seau local que le serveur (derriere la box), Ã©ditez le fichier `wg0.conf` uploadÃ© sur cette machine en changeant avec l'adresse locale du serveur : `Endpoint = ipduserveur:51820`{lang=properties}
:::
::

Et voilÃ  ce que cela peut donner !

![picture](/img/serveex/wireguard.svg)