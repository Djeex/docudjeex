---
navigation: true
title: Cloudflare Zero Trust
main:
  fluid: false
---
:ellipsis{left=0px width=40rem top=10rem blur=140px}
# Cloudflare Zero Trust

::alert{type="info"}
üéØ __Objectifs :__
  - Comprendre le principe des Tunnels Cloudflare
  - Param√©trer son compte cloudflare
  - Param√©trer SWAG
  - G√©rer plusieurs tunnels
::

![cloudfare_tunnels](/img/serveex/cloudflared.svg)

## Introduction
---
L'architecture _Zero Trust_ est la pratique consistant √† concevoir des syst√®mes fond√©s sur le principe de __¬´ ne jamais faire confiance__, __toujours v√©rifier ¬ª__, par opposition au principe traditionnel de __¬´ confiance, mais v√©rifier ¬ª__. Ce concept est devenu tr√®s populaires r√©cemment, √† la suite des attaques toujours plus nombreuses concernant les donn√©es des utilisateurs. C'est un concept tr√®s large, nous nous concentrerons sur l‚Äôapplication du _Zero Trust_ aux services Web que nous h√©bergeons.

Les _tunnels Cloudflare_ offrent un moyen simple d'arriver au _Zero Trust_, en s'appuyant sur [SWAG](/serveex/coeur/swag) et [Authentik](/serveex/securite/authentik).

Pour le dire simplement, les Tunnels Cloudflare permettent notamment de :

- Masquer l'IP de votre serveur (et donc de votre box s'il est h√©berg√© chez vous).
- D'authentifier le traffic.
- De b√©n√©ficier des protection de Cloudflare (attaques DDOS, etc, blacklist, requ√™tes malveillantes, etc...).
- De b√©n√©ficier du CDN, c'est √† dire du serveur de cache de Cloudlfare, qui permet d'augmenter les performances de vos sites web.
- De ne plus avoir besoin de l'ouverture de ports de votre routeur pour les services expos√©s par SWAG.

Ici, nous expliquerons comment associer SWAG aux tunnels Cloudflare.

::alert{type="warning"}
:::list{type="warning"}
- __Attention :__
:::
- N'utilisez pas les tunnels Cloudflare pour exposer un serveur mail
- N'utilisez pas les tunnels Cloudflare pour exposer un service vid√©o, comme Plex (si vous avez [suivi ce guide](/serveex/media/plex), Plex n'est pas expos√©, c'est donc valide)
- N'utilisez pas les tunnels Cloudflare pour utiliser le protocole bittorrent (si vous avez [suivi ce guide](/serveex/media/qbittorrent), tout est bon)
::

## Configuration Cloudflare
---
### Zone DNS

Avant toute chose, vous devez d√©finir Cloudflare comme gestionnaire de votre [zone DNS](/generalites/reseau/dns). Si vous avez r√©serv√© votre nom de domaine chez Cloudflare, c'est d√©j√† le cas. Sinon, renseignez vous aupr√®s de votre registrar sur comment ajouter des DNS externes. Cloudflare dispose d'[une documentation expliquant pas √† pas comment param√©trer une Zone DNS](https://developers.cloudflare.com/dns/zone-setups/full-setup/setup/), que vous ayez un domaine externe ou reserv√© chez Cloudflare.

Si vous avez qu'un seul serveur √† prot√©ger derri√®re Cloudflare, vous pouvez supprimer l'ensemble des enregistrement DNS existant, par d√©faut le domaine et tout ses sous-domaines seront directement redirig√©s vers le tunnel.

Si vous avez des sous-domaines √† rediriger vers d'autres serveurs, vous pourrez toujours les d√©clarer dans la zone DNS √† l'aide d'un enregistrement A.

Si vous avez plusieurs serveurs et donc plusieurs tunnels pour un meme domaine principal, [voyez ici](http://192.168.7.80:8005/serveex/cloudflare/#gerer-plusieurs-tunnels-pour-plusieurs-serveurs).

### Cl√© API

Pour commencer, nous devons cr√©er un nouveau jeton API pour Cloudflare et r√©cup√©rer nos identifiants de zone et de compte. 

Sur le tableau de bord de Cloudflare, dans la page de pr√©sentation de votre domaine, vous pouvez voir les identifiants de `zone` et de `compte` en bas √† droite de l'√©cran. Copiez pr√©cieusement ces deux identifiants.

![id and account](/img/serveex/cf-id.png)

Juste en dessous d'eux, il y a un lien intitul√© _Obtenez votre jeton API_. Cliquez dessus. Le p√©rim√®tre dont nous avons besoin pour le jeton doit inclure `Zone:DNS:Edit` et `Account:Cloudflare Tunnel:Edit`. Assurez-vous que votre page de cr√©ation de token ressemble √† celle illustr√©e dans la capture d'√©cran ci-dessous. 

![API token](/img/serveex/cf-token.png)

Une fois que nous aurons enregistr√©, notre jeton sera affich√© une fois. copiez le pr√©cieusement, car vous ne pourrez plus le revoir apr√®s la fermeture.

### Cloudflare Zero Trust

Vous devez vous inscrire √† _Cloudflare Teams_ pour pouvoir acc√©der au tableau de bord _Zero Trust_ qui g√®re les tunnels et les politiques d'acc√®s. Il s'agit d'un service premium, mais ils proposent un forfait gratuit pour un maximum de 50 utilisateurs, ce qui devrait suffire pour votre Home Lab. Gardez √† l‚Äôesprit que puisqu‚Äôil s‚Äôagit d‚Äôune fonctionnalit√© premium, ils demandent une carte de cr√©dit valide lors de l‚Äôinscription, mais avec le forfait gratuit, il n'y aura aucun frais. 

Inscrivez-vous [via ce lien](https://dash.teams.cloudflare.com/).


## Configuration de Swag
---
::alert{type="info"}
:::list{type="info"}
- Nous partons du principe que vous avez le domaine `mondomaine.fr` avec les DNS qui pointent bien vers ceux de Cloudflare, comme vu pr√©c√©demment.
:::
::

SWAG dispose de deux `Docker Mods` permettant d'y int√©grer :

- __Cloudflared__, le conteneur qui permet de cr√©er et de g√©rer les tunnels
- __Cloudflared Real IP__, un conteneur qui permet √† SWAG d'obtenir la vraie source IP des requ√™tes depuis internet plutot que celle de Docker (ce qui pourrait entrer en conflit avec le mod de g√©olocalisatioN DBIP).

Ces deux mods, fusionn√©s dans le conteneur de SWAG, n√©cessitent un peu de configuration.

### Configuration du tunnel

Pour configurer les tunnels, nous aurons besoin de cr√©er un fichier `tunnelconfig.yml` auquel nous ferons appel dans le `compose.yaml` de SWAG.

::alert{type="success"}
‚ú® __Astuce :__ vous pouvez utiliser [File Browser](/serveex/files/file-browser) pour naviguer dans vos fichier et √©diter vos documents au lieu d'utiliser les commandes du terminal.
::

```sh
sudo vi /docker/swag/config/tunnelconfig.yml
```

Entrez en modification avec la touche `i` et collez la configuration ci-dessous

```yaml
ingress:
  - hostname: mondomaine.fr
    service: https://mondomaine.fr
  - hostname: "*.mondomaine.fr"
    service: https://mondomaine.fr
  - service: http_status:404
```

Appuyez sur `Echap` puis sauvegardez et quittez en tapant `:x` puis en appuyant sur `Entr√©e`.

### Configuration de Cloudflare Real IP

A pr√©sent, nous allons configurer le bon fonctionnement du mode _Cloudflare Real IP_

Ouvrez le fichier `nginx.conf`

```sh
sudo vi /docker/swag/config/nginx/nginx.conf
```
Entrez en modification avec la touche `i` et collez la configuration ci-dessous √† la fin de la section `http`

```nginx
real_ip_header X-Forwarded-For;
real_ip_recursive on;
include /config/nginx/cf_real-ip.conf;
set_real_ip_from 127.0.0.1;
```
Appuyez sur `Echap` puis sauvegardez et quittez en tapant `:x` puis en appuyant sur `Entr√©e`.

### Docker compose

Ouvrez Dockge, √©ditez la stack SWAG avec cette configuration

```yaml
---
services:
  swag:
    image: lscr.io/linuxserver/swag:latest
    container_name: swag
    cap_add:
      - NET_ADMIN
    env_file:
      - .env
    environment:
      - DOCKER_MODS=linuxserver/mods:swag-dbip|linuxserver/mods:swag-dashboard|linuxserver/mods:swag-auto-reload|linuxserver/mods:universal-cloudflared|linuxserver/mods:swag-cloudflare-real-ip
      - PUID=${PUID}
      - PGID=${PGID}
      - TZ=Europe/Paris
      - URL=${DOMAIN}
      - SUBDOMAINS=wildcard
      - VALIDATION=dns
      - DNSPLUGIN=${PLUGIN}
      - EMAIL=${EMAIL}
      - CF_ZONE_ID=${ZONE_ID}
      - CF_ACCOUNT_ID=${ACCOUNT_ID}
      - CF_API_TOKEN=${API_TOKEN}
      - CF_TUNNEL_NAME=${TUNNEL_NAME}
      - CF_TUNNEL_PASSWORD=${TUNNEL_PW}
      - FILE__CF_TUNNEL_CONFIG=/config/tunnelconfig.yml
    extra_hosts:
      - ${DOMAIN}:127.0.0.1
    ports:
      - 81:81
    volumes:
      - /docker/swag/config:/config
      - /docker/swag/config/fail2ban/fail2ban.sqlite3:/dashboard/fail2ban.sqlite3:ro
    restart: unless-stopped
```

::alert{type="success"}
‚ú® __Astuce :__ ajoutez le label de watchtower dans chaque conteneur afin d'automatiser les mises √† jour

    ```yaml
    services:
      swag:
        #...
        labels:
          - com.centurylinklabs.watchtower.enable=true
::


Et renseignez le `.env` les infos que vous avez trouv√©es et not√©es tout au long de ce guide

```properties
PUID=
PGID=
DOMAIN=
PLUGIN=
EMAIL=
ZONE_ID=
ACCOUNT_ID=
API_TOKEN=
TUNNEL_NAME=
TUNNEL_PW=
```

| Variable                          | Valeur                                                                                                    | Exemples                       |
|-----------------------------------|-----------------------------------------------------------------------------------------------------------|--------------------------------|
| `PUID`{lang=properties}            | A renseigner avec les infos de votre user (trouvables via la commande `id nomdutilisateur`{lang=shell}) | `1000`                           |
| `GUID`{lang=properties}              | A renseigner avec les infos de votre user (trouvables via la commande `id nomdutilisateur`{lang=shell}) | `1000 `                          |
| `DOMAIN`{lang=properties}            | Le domaine que vous avez r√©serv√©                                                                          | `mondomaine.fr`                  |
| `PLUGIN`{lang=properties}            | Le fournisseur de zone DNS, ici Cloudflare. Pensez √† renseigner `cloudflare.ini` (voir [guide de swag](https://docs.linuxserver.io/general/swag/#create-container-via-dns-validation-with-a-wildcard-cert))                                                                | `cloudflare`                     |
| `EMAIL`{lang=properties}             | Votre email pour le certificat                                                                            | `votre@email.fr`                 |
| `ZONE_ID`{lang=properties}           | L'ID de Zone que vous avez not√© pr√©c√©demment                                                              | `aNhcz1l3JfWbFZo2XMpzQlP2iOqk`   |
| `ACCOUNT_ID`{lang=properties}        | L'ID de Compte que vous avez not√© pr√©c√©demment                                                            | `buKsjNHLyzKMM1qYnzOy4s7SHfly`   |
| `API_TOKEN`{lang=properties}         | Le jeton d'API que vous avez not√© pr√©c√©demment                                                            | `53ydYus9TFFk1DOXNdP87iIcJtQjoW` |
| `TUNNEL_NAME`{lang=properties}       | Le nom de votre tunnel                                                                                    | `mon_tunnel`                     |
| `TUNNEL_PW`{lang=properties}   | Un mot de passe fort g√©n√©r√© al√©atoirement                                                                 | `iSzKRmP4VbnlsMvdSdgBEJiJi`      |

Une fois fait, d√©ployez la stack. Cela prendra un peu de temps, v√©rifiez les logs, vous devriez arriver √† `serveur ready`

Une fois le conteneur en ligne, v√©rifiez dans cloudflare que votre tunnel est bien pr√©sent dans la section _Networks > Tunnels_ de [Cloudflare Zero Trust](https://one.dash.cloudflare.com/). Par d√©faut, l'ensemble des sous domaine sont redirig√©s vers le tunnel, sans avoir besoin de les d√©clarer [dans votre zone DNS](/generalites/reseau/dns).

::alert{type="success"}
‚ú® __Astuce:__ si vous voulez exposer un service sans tunnel, vous pouvez toujours d√©clarer un enregistrement A [dans votre zone DNS](/generalites/reseau/dns). En cas de probl√®me de r√©solution, d√©sactivez la fonction _proxy_ pour cet enregistrement. Par exemple pour `sous.mondomaine.fr`
![dns](/img/serveex/cf-dns.png)
::


## G√©rer plusieurs tunnels pour plusieurs serveurs
---
Par d√©faut, l'ensemble des sous domaine de votre nom de domaine pointent vers le tunnel que vous avez cr√©√©. Mais si vous avez un second serveur, vous pouvez avoir un second tunnel en changeant seulement le nom de tunnel dans la configuration de l'instance swag de votre serveur.

Vous devrez ensuite dans votre zone DNS rediriger les sous domaine souhait√© vers le bon tunnel. Pour cela, faites comme suit.

Rendez-vous dans dans la section _Networks > Tunnels_ de [Cloudflare Zero Trust](https://one.dash.cloudflare.com/).

Notez les deux ID des tunnels

![tunnels_id](/img/serveex/cf-tunnels-id.png)

Rendez-vous √† pr√©sent dans la section DNS de [cloudflare](https://dash.cloudflare.com/), apr√®s avoir cliqu√© sur le nom de domaine concern√©. 

Cliquez sur `ajouter un enregistrement` et ajoutez deux enregistrements comme suit en ajoutant bien `.cfargotunnel.com` apr√®s vos id de tunnels.

| Type    | Nom            | Cible                               |
|---------|----------------|-------------------------------------|
| `CNAME` | `sousdomaine1` | `votreiddetunnel1.cfargotunnel.com` |
| `CNAME` | `sousdomaine2` | `votreiddetunnel2.cfargotunnel.com` |



Si vous avez de nombreux sous-domaines, vous pouvez d√©clarer un seul sous domaine par tunnel comme ci-dessus, puis d√©clarer vos autres sous domaine en les faisant pointer vers ces sous domaines de r√©f√©rence.

Ainsi, en cas de changement d'id de tunnel, vous n'aurez qu'√† le changer que pour un seul sous-domaine.
Par exemple :
    
- Le serveur de `sousdomaine1` doit egalement etre la cible de sub1, et sub2 :

    | Type    | Nom            | Cible                               |
    |---------|----------------|-------------------------------------|
    | `CNAME` | `sub1` | `sousdomaine1` |
    | `CNAME` | `sub2` | `sousdomaine1` |
    
- Le serveur de `sousdomaine2` doit egalement etre la cible de sub3, et sub4 :

    | Type    | Nom            | Cible                               |
    |---------|----------------|-------------------------------------|
    | `CNAME` | `sub3` | `sousdomaine2` |
    | `CNAME` | `sub4` | `sousdomaine2` |

