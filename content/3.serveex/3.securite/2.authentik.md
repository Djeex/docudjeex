---
navigation: true
title: Authentik
main:
  fluid: false
---
:ellipsis{left=0px width=40rem top=10rem blur=140px}
# Authentik

::alert{type="info"}
üéØ __Objectifs :__
- Installer et exposer Authentik
- Param√©trer le Multi-Facteur
- Prot√©ger une app native ou via reverse proxy
::

[Authentik](https://goauthentik.io) est un outil d'authentification unique permettant de vous logger une seule fois sur les plateformes compatibles OpenID. Il permet √©galement de s√©curiser l'acc√®s aux services que vous exposez, en s'injectant via SWAG aux requetes vers vos services. 

Ainsi, si vous exposez Dockge sur internet via `dockge.mondomaine.fr`, au moment de l'acc√®s √† cette page, vous tomberez sur une page de login d'authentik. Si vous avez d√©j√† √©t√© identifi√© sur un autre service s√©curis√© par authentik auparavant, alors vous serez d√©j√† identifi√©. cela permet d'avoir √† vous identifiez qu'une seule fois par jour sur l'ensemble des services prot√©g√©s par authentik.

Authentik permet aussi d'utiliser le multi-facteur, notamment par TOTP (code g√©n√©r√© par une application d'authentification de votre choix. Enfin, authentik permet aussi de se connecter directement via un compte Microsoft ou Google, si vous avez configur√© une application d'un de ces services.

C'est une bonne mani√®re de se passer de VPN pour exposer vos services, et d'exposer des services qui ne sont pas prot√©g√©s par du MFA voir pas prot√©g√©s par des login (comme le dashboard de swag). 

Authentik dipose d'[une doc tr√®s fournie](https://docs.goauthentik.io/docs/installation/docker-compose) et des [fabuleux tuto de Cooptonian](https://www.youtube.com/@cooptonian). Ici, nous montrerons juste les bases, avec l'exemple de l'exposition de Dockge.

Deux modes principaux sont √† connaitre: 

- Le premier permet √† une application qui dispose nativement d'une int√©gration avec du SSO compatible OpenID de se connecter directement √† Authentik. C'est la solution √† privil√©gier car elle permet de laisser l'application d√©cider de ce qui est public et de ce qui est prot√©g√©.

![Picture](/img/serveex/auth-native.svg)

- Le second permet d'injecter une authentification via authentik grace √† SWAG avant d'arriver sur le service d√©sir√©.

![Picture](/img/serveex/auth-proxy.svg)

Les deux modes son configurables application par application.



## Installation
---
Structure des dossiers :
```console
root
‚îî‚îÄ‚îÄ docker
    ‚îî‚îÄ‚îÄ authentik
        ‚îú‚îÄ‚îÄ .env
        ‚îú‚îÄ‚îÄ compose.yml
        ‚îú‚îÄ‚îÄ media
        ‚îú‚îÄ‚îÄ certs
        ‚îú‚îÄ‚îÄ custom-template
        ‚îî‚îÄ‚îÄ ssh
```

Cr√©ez les dossiers : 

```shell
sudo mkdir -p /docker/authentik/media /docker/authentik/certs /docker/authentik/custom-template /docker/authentik/ssh
```

Positionnez vous dans le dossier `authentik` et g√©n√©rez un mot de passe et une cl√© secrete que l'on va int√©grer dans le .env :

```shell
sudo echo "PG_PASS=$(openssl rand 36 | base64)" >> .env
sudo echo "AUTHENTIK_SECRET_KEY=$(openssl rand 60 | base64)" >> .env
```
::alert{type="info"}
:::list{type="info"}
- Afin de g√©n√©rer la cl√©, nous avons cr√©√© les dossiers en amont du d√©ploiement via Dockge. Dockge vous empechera de cr√©er une stack du meme nom dans ces dossiers s'il n'existe pas de `compose.yml`. Il faut donc cr√©er un `compose.yml` vide afin que ce dernier la reconnaisse comme existante dans les stacks inactives :
:::
    ```shell
    sudo vi /docker/authentik/compose.yml
::

Ouvrez dockge, et cherchez "authentik" dans les stack inactives.
Nommez la stack authentik et collez la configuration suivante, en changeant les chiffres de `{AUTHENTIK_TAG:-2025.6.3}`{lang=properties} par [la derni√®re version de Authentik](https://goauthentik.io/docs/releases). 

```yaml
---
services:

  postgresql:
    image: docker.io/library/postgres:16-alpine
    container_name: authentik-postgresql
    restart: unless-stopped
    healthcheck:
      test:
        - CMD-SHELL
        - pg_isready -d $${POSTGRES_DB} -U $${POSTGRES_USER}
      start_period: 20s
      interval: 30s
      retries: 5
      timeout: 5s
    volumes:
      - database:/var/lib/postgresql/data
    environment:
      POSTGRES_PASSWORD: ${PG_PASS:?database password required}
      POSTGRES_USER: ${PG_USER:-authentik}
      POSTGRES_DB: ${PG_DB:-authentik}
    env_file:
      - .env

  redis:
    image: docker.io/library/redis:alpine
    container_name: authentik-redis
    command: --save 60 1 --loglevel warning
    restart: unless-stopped
    healthcheck:
      test:
        - CMD-SHELL
        - redis-cli ping | grep PONG
      start_period: 20s
      interval: 30s
      retries: 5
      timeout: 3s
    volumes:
      - redis:/data
  
  server:
    image: ${AUTHENTIK_IMAGE:-ghcr.io/goauthentik/server}:${AUTHENTIK_TAG:-2025.2.1}
    container_name: authentik-server
    restart: unless-stopped
    command: server
    environment:
      AUTHENTIK_REDIS__HOST: redis
      AUTHENTIK_POSTGRESQL__HOST: postgresql
      AUTHENTIK_POSTGRESQL__USER: ${PG_USER:-authentik}
      AUTHENTIK_POSTGRESQL__NAME: ${PG_DB:-authentik}
      AUTHENTIK_POSTGRESQL__PASSWORD: ${PG_PASS}
    volumes:
      - ./media:/media
      - ./custom-templates:/templates
      - ./ssh:/authentik/.ssh
    env_file:
      - .env
    ports:
      - ${COMPOSE_PORT_HTTP:-9000}:9000
      - ${COMPOSE_PORT_HTTPS:-9443}:9443
    depends_on:
      - postgresql
      - redis

  worker:
    image: ${AUTHENTIK_IMAGE:-ghcr.io/goauthentik/server}:${AUTHENTIK_TAG:-2025.2.1}
    container_name: authentik-worker
    restart: unless-stopped
    command: worker
    environment:
      AUTHENTIK_REDIS__HOST: redis
      AUTHENTIK_POSTGRESQL__HOST: postgresql
      AUTHENTIK_POSTGRESQL__USER: ${PG_USER:-authentik}
      AUTHENTIK_POSTGRESQL__NAME: ${PG_DB:-authentik}
      AUTHENTIK_POSTGRESQL__PASSWORD: ${PG_PASS}
    # `user: root` and the docker socket volume are optional.
    # See more for the docker socket integration here:
    # https://goauthentik.io/docs/outposts/integrations/docker
    # Removing `user: root` also prevents the worker from fixing the permissions
    # on the mounted folders, so when removing this make sure the folders have the correct UID/GID
    # (1000:1000 by default)
    user: root
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock
      - ./media:/media
      - ./certs:/certs
      - ./custom-templates:/templates
      - ./ssh:/authentik/.ssh
    env_file:
      - .env
    depends_on:
      - postgresql
      - redis

volumes:
  database:
    driver: local
  redis:
    driver: local
```

Dans le point `.env`, les variables `PG_PASS` et `AUTHENTIK_SECRET_KEY` sont d√©j√† remplies.
D√©ployez la stack.

Vous pouvez alors commencer le set-up d'authentik en tappant `http://ipduserveur:9000/if/flow/initial-setup/`.

::alert{type="warning"}
:::list{type="warning"}
- __Attention :__ il est conseill√© de cr√©er un nouveau compte admin, et de **d√©sactiver** le compte admin de base `akadmin`.
:::
::

## Exposer authentik
---
Pour √™tre utilisable hors de chez vous, vous devez exposer authentik.

::alert{type="info"}
üìã __Au pr√©alable :__  <br/><br/>
Nous partons du principe quer vous avez cr√©√© dans votre [zone DNS](/generalites/dns) un sous domaine du type `auth.mondomaine.fr` avec pour CNAME `mondomaine.fr` et, [√† moins que vous utilisiez Cloudflare Zero Trust](/serveex/securite/cloudflare), vous avez d√©j√† redirig√© le port `443` de votre box vers le `443` de votre serveur dans [les r√®gles NAT](/generalites/nat).
::

Ouvrez le fichier `authentik-server.conf`.

::alert{type="success"}
‚ú® __Astuce pour les allergiques au terminal :__
vous pouvez utiliser [File Browser](/serveex/files/file-browser) pour naviguer dans vos fichier et √©diter vos documents au lieu d'utiliser les commandes du terminal.
::

```shell
sudo vi /docker/swag/config/nginx/authentik-server.conf
```

V√©rifiez que dans chaque cas les variables ci-dessous sont correctes :

```nginx
set $upstream_authentik authentik-server;
proxy_pass http://$upstream_authentik:9000;
```

Si ce n'est pas le cas, passez en mode modification en tapant `i` et √©ditez les. Sauvegardez et quittez en tapant sur `Echap` puis `:x`.

Cr√©ez le fichier `auth.subdomain.conf`

```shell
sudo vi /docker/swag/config/nginx/proxy-confs/auth.subdomain.conf

```

Appuyez sur `i` pour rentrer en mode modification puis collez la configuration suivante :

```nginx
## Version 2023/05/31
# make sure that your authentik container is named authentik-server
# make sure that your dns has a cname set for authentik

server {
    listen 443 ssl;
    listen [::]:443 ssl;

    server_name auth.*;

    include /config/nginx/ssl.conf;

    client_max_body_size 0;

    location / {

        include /config/nginx/proxy.conf;
        include /config/nginx/resolver.conf;
        set $upstream_app authentik-server;
        set $upstream_port 9000;
        set $upstream_proto http;
        proxy_pass $upstream_proto://$upstream_app:$upstream_port;

    }

    location ~ (/authentik)?/api {
        include /config/nginx/proxy.conf;
        include /config/nginx/resolver.conf;
        set $upstream_app authentik-server;
        set $upstream_port 9000;
        set $upstream_proto http;
        proxy_pass $upstream_proto://$upstream_app:$upstream_port;

    }
}
```

Sauvegardez et quittez en appuyant sur `Echap` puis en tapant `:x`.

Rendez-vous dans dockge, et √©ditez le compose de SWAG en ajoutant le r√©seau d'Authentik :

```yaml
services:
  swag:
     container_name: # ...
      # ... 
     networks:               # Relie le conteneur au r√©seau custom 
      # ...           
      - authentik            # Nom du r√©seau d√©clar√© dans la stack
    
networks:                    # D√©finit le r√©seau custom
  # ...
  authentik:                 # Nom du r√©seau d√©clar√© dans la stack
    name: authentik_default  # Nom v√©ritable du r√©seau externe
    external: true           # Pr√©cise que c'est un r√©seau √† rechercher en externe
```

Relancez la stack et patientez le temps que SWAG soit compl√®tement op√©rationnel.

Et voil√† ! Vous pouvez acc√©der √† authentik via `https://auth.mondomaine.fr`

## Activer le multifacteur
---
Tout l'int√©r√™t de authentik c'est de disposer du multifacteur pour toutes les apps que l'on prot√®gera.
 
- Rendez vous sur `https://auth.mondomaine.fr`
- Identifiez-vous
- Rendez-vous dans _param√®tres_
- Cliquez sur la section _MFA_
- Cliquez sur _s'inscrire_
- Choisissez une m√©thode comme _TOTP device_ ( dans ce cas vous devrez utilisez une app d'authentification telle que Google Authenticator par exemple)
- Suivez les √©tapes

Et voil√†, vous serez invit√© √† saisir un code √† usage unique √† chaque connexion.

## Prot√©ger une app native
---
Authentik est compatible nativement avec un certain nombre d'application, vous retrouverez la liste et [le support ici](https://docs.goauthentik.io/integrations/services/)

## Prot√©ger une app par reverse proxy
---
Swag permet d'intercaler la page d'authentik entre la requ√™te et l'acc√®s √† votre service. Pour cela il va falloir :

- Configurer le service d'authentification dans authentik.
- Configurer le fichier proxy du domaine pour que swag puisse intercaler la page.

Pourquoi le faire alors que Dockge a d√©j√† une page d'authentification ? Tout simplement parce que l'authentification HTTP utilis√©e par Dockge est faible. Avec Authentik, vous aurez directement une authentification forte par MFA, et vous serez logg√© automatiquement √† toutes vos apps d√©j√† prot√©g√©es par authentik. Cela permet de s√©curiser l'acc√®s √† Dockge et aux autres apps que vous prot√©gerez, sans avoir √† passer par un VPN.

### Configuration de Authentik

- Rendez vous dans Authentik
- Allez dans le panneau d'administration
- S√©lectionnez _application_ puis _cr√©er avec l'assistant_
- Renseignez les champs comme suit :

![Picture](/img/serveex/auth1.png)

- Puis √† l'√©tape suivante choisissez "Transf√©rer l'authentification (application unique)" et √©ditez comme suit (attention aux flow, c'est important) :

![Picture](/img/serveex/auth2.png)

- Ensuite, allez dans le menu √† gauche dans _Avant-poste_ et √©ditez _authentik Embedded Outpost_

![Picture](/img/serveex/auth3.png)

- Ajoutez l'application `dockge` en la faisant passer √† droite et validez.

### Configuration de SWAG

Ensuite rendez-vous dans le fichier `dockge.mondomaine.fr`.

```shell
sudo vi /docker/swag/config/nginx/proxy-confs/dockge.subdomain.conf
```

Puis entrez en modification en appuyant sur `i` et enlevez les `#` des deux lignes `#include /config/nginx/authentik-server.conf;`{lang=nginx}.

Appuyez sur `Echap` puis tapez `:x` et appuyez sur `Entr√©e` pour sauvegarder et quitter.

Et voil√† ! En tapant `https://dockge.mondomaine.fr`, vous tomberez √† pr√©sent sur la mire d'authentification de authentik. 

::alert{type="success"}
‚ú® __Astuce :__ dans Dockge, dans les param√®tres, vous pouvez d√©sactiver l'authentification de Dockge afin de ne pas avoir √† vous identifier deux fois. **Attention**, cela voudra dire que si vous avez expos√© un port sur votre r√©seau local, il n'y aura plus aucune authentification.
::

::alert{type="info"}
:::list{type="info"}
- Vous pouvez r√©p√©tez l'op√©ration pour chaque application que vous souhaitez prot√©ger (si elle ne dipose pas d'int√©gration directe avec Authentik).
:::
::

Voil√† votre nouvelle architecture :

![Picture](/img/serveex/authentik.svg)

## Prot√©ger un service sur un serveur distant
---
Dans le cas d'une application [native](/serveex/securite/authentik#prot√©ger-une-app-native) (via OAuth 2.0 ou autre), rien ne change.

Dans le cas d'une application non native √† prot√©ger derri√®re un reverse proxy, vous devrez d√©ployer un __avant-poste__. Un avant-poste est un conteneur qui jouera le r√¥le de proxy local, c'est √† dire que c'est vers ce conteneur que les requ√™tes d'authentification de vos applications seront redirig√©es. C'est le seul qui est autoris√© √† dialoguer avec l'API de votre instance authentik.


::alert{type="info"}
Pr√©-requis :
- Avoir install√© [docker](/serveex/coeur/docker) sur votre machine distante h√©bergeant le service √† prot√©ger.
- Si l'application n'a pas d'int√©gration native, avoir un reverse proxy compatible. Comme partout ici, nous utiliserons [SWAG](/serveex/coeur/swag).
:: 

Ce conteneur redirigera ensuite les requetes vers votre instance [Authentik](/serveex/securite/authentik#authentik) principale, √† travers le web (ou votre r√©seau local). Le serveur executera les controle et renverra la r√©ponse √† l'_avant-poste_, qui bloquera ou non la connexion √† l'app prot√©g√©e.

![auth-outpost](/img/serveex/auth-outpost.svg)

### Configuration d'Authentik

Cr√©ez vos [fournisseurs et applications](/serveex/securite/authentik#prot√©ger-une-app-native) comme nous l'avons vu plus haut.

Puis, dans votre panneau admin, allez dans la rubrique _Applications > Avant-postes_, puis cr√©ez un nouvel avant-poste.

Remplissez comme suit :


| Champs         | Valeur                                                                |
|----------------|-----------------------------------------------------------------------|
| `Nom`          | Le nom que vous souhaitez                                             |
| `Type`         | `Proxy`                                                               |
| `Int√©gration`  | Laissez vide                                                          |
| `Applications` | S√©lectionnez le ou les applications que vous avez cr√©√©es pr√©c√©demment |

Dans la section `Param√®tres avanc√©s`, supprimez l'existant, et compl√©tez comme suit :

```yaml
log_level: info
docker_labels: null
authentik_host: https://domaine_de_votre_serveur_authentik/
object_naming_template: ak-outpost-%(name)s
authentik_host_insecure: false
container_image:
docker_network: null
docker_map_ports: true
docker_labels: null
```

Enrtegistrez et quittez.

Sur l'√©cran affichant les avant-postes cr√©√©s, vous verrez le nouvel avant-poste que vous venez de cr√©er. A la fin de la ligne, cliquez sur _afficher les informations_, et copiez pr√©cieusement le jeton d'acc√®s.

### Configuration de la machine distante

Nous partons du principe que vous avez d√©j√† install√© [Docker](/serveex/coeur/docker) et [SWAG](/serveex/coeur/swag) sur cette machine distante.

Sur votre machine distante, √† l'aide de [Dockge](/serveex/coeur/docker/#installer-dockge-pour-g√©rer-et-d√©ployer-les-conteneurs), cr√©ez une stack `authentik-outpost`.

Si vous n'avez pas install√© [Dockge](/serveex/coeur/docker/#installer-dockge-pour-g√©rer-et-d√©ployer-les-conteneurs), cr√©ez un dossier `/docker/authentik-outpost`, ou directement en ligne de commande :

```shell
sudo mkdir -P /docker/authentik-outpost
```

::alert{type="success"}
‚ú® __Astuce pour les allergiques au terminal :__
vous pouvez utiliser [File Browser](/serveex/files/file-browser) pour naviguer dans vos fichier et √©diter vos documents au lieu d'utiliser les commandes du terminal.
::

Cr√©ez le fichier `compose.yaml` ou copiez la configuration directement dans le champs si vous avez [Dockge](/serveex/coeur/docker/#installer-dockge-pour-g√©rer-et-d√©ployer-les-conteneurs)

En ligne de commande :

```shell
sudo vi /docker/authentik-outpost/compose.yaml
```
Entrez en mode modification avec `i` et collez la configuration suivante, en changeant les chiffres de `{AUTHENTIK_TAG:proxy:2024.2.3}`{lang=properties} par la meme version que celle de votre serveur Authentik. 

```yaml
version: "3.5"
services:
  authentik_proxy:
    container_name: authentik-outpost
    image: ghcr.io/goauthentik/proxy:2024.2.3
    # Optionally specify which networks the container should be
    # might be needed to reach the core authentik server
    restart: unless-stopped
    env_file:
      - .env
    #   - foo
    ports:
      - 9000:9000
      - 9443:9443
    environment:
      AUTHENTIK_HOST: ${HOST}
      AUTHENTIK_INSECURE: "false"
      AUTHENTIK_TOKEN: ${TOKEN}
      # Starting with 2021.9, you can optionally set this too
      # when authentik_host for internal communication doesn't match the public URL
      # AUTHENTIK_HOST_BROWSER: https://external-domain.tld
```

Rendez-vous sur la stack de SWAG de la machine distante (ou remplissez directement si vous avez [Dockge](/serveex/coeur/docker/#installer-dockge-pour-g√©rer-et-d√©ployer-les-conteneurs)) et ajoutez le r√©seau de authentik-outpost dans le fichier de conf sur ce modele (les champs `networks`) :


```shell
sudo vi /docker/swag/compose.yaml
```

```yaml
services:
  swag:
     container_name: #...
      # ... 
     networks:                      # Relie le conteneur au r√©seau custom 
      - authentik-outpost           # Nom du r√©seau d√©clar√© dans la stack
    
networks:                           # D√©finit le r√©seau custom
  #...
  authentik-outpost:                # Nom du r√©seau d√©clar√© dans la stack
    name: authentik-outpost_default # Nom v√©ritable du r√©seau externe
    external: true                  # Pr√©cise que c'est un r√©seau √† rechercher en externe
```

Appuyez sur `Echap` puis tapez `:x` et appuyez sur `Entr√©e` pour sauvegarder et quitter.

::alert{type="info"}
:::list{type="info"}
- Ici nous partons du principe que le nom du r√©seau de dockge est `authentik-outpost_default`.
:::
::

Si vous avez [Dockge](/serveex/coeur/docker/#installer-dockge-pour-g"rer-et-d"ployer-les-conteneurs), relancez SWAG.

Sinon, via le terminal :

```shell
cd /docker/swag/
sudo docker compose up -d
```

Creez (ou remplissez directement si vous avez [Dockge](/serveex/coeur/docker/#installer-dockge-pour-g√©rer-et-d√©ployer-les-conteneurs)) le fichier `.env` dans le dossier de l'avant poste authentik :

En ligne de commande :

```shell
sudo vi /docker/authentik-outpost/.env
```

Entrez en mode modification avec `i` et collez la configuration suivante

```properties
HOST=
TOKEN=
```
Remplissez comme suit

| Variable                | Valeur                                                  | Exemple                    |
|-------------------------|---------------------------------------------------------|----------------------------|
| `HOST`{lang=properties}  | L'url de votre serveur authentik                        | `https://auth.domaine.fr`  |
| `TOKEN`{lang=properties} | Le token que vous avez pr√©c√©demment copi√© pr√©cieusement | `Q2pVEqsTNRkJSO9SkJzU3KZ2` |

Appuyez sur `Echap` puis tapez `:x` et appuyez sur `Entr√©e` pour sauvegarder et quitter.

Si vous avez [Dockge](/serveex/coeur/docker/#installer-dockge-pour-g"rer-et-d"ployer-les-conteneurs), d√©ployez la stack.

Sinon, via le terminal :

```shell
cd /docker/authentik-outpost/
sudo docker compose up -d
```

Le conteneur est en route, vous pouvez v√©rifier son √©tat dans votre panneau admin de votre instance Authentik, section _Applications > Avant-postes_. 


Nous allons a pr√©sent configurer SWAG.

Ouvrez le fichier `authentik-server.conf`.

```shell
sudo vi /docker/swag/config/nginx/authentik-server.conf
```

Dans le fichier, passez en mode modification en tapant `i` et changez `authentik-server` par `authentik-outpost` comme suit :

```nginx
set $upstream_authentik authentik-outpost;
proxy_pass http://$upstream_authentik:9000;
```

Sauvegardez et quittez en tapant sur `Echap` puis `:x` et sur `Entr√©e`.

Ensuite, configurez les applications √† prot√©ger selon si elles sont [natives](/serveex/securite/authentik#prot√©ger-une-app-native) ou par [proxy](/serveex/securite/authentik#prot√©ger-une-app-par-reverse-proxy) comme vous l'avez fait sur votre serveur principal.

## Migrer une base authentik
---
Sur la machine d'origine, dumper la bdd :

```shell
sudo docker exec authentik-postgres pg_dump -U authentik -F t authentik > /path/to/mydb.tar
```

Puis l'envoyer sur la machine cible. Sur la machine cible, copier le fichier dans le container docker

```shell
cp /path/to/mydb.tar authentik-postgres:/path/to/wherever
```

(Optionnel) Purgez les tables existantes :

```shell
sudo docker exec -i authentik-postgres psql -U authentik -c "SELECT pg_terminate_backend(pg_stat_activity.pid) FROM pg_stat_activity WHERE pg_stat_activity.datname = 'authentik' AND pid <> pg_backend_pid();" && \
sudo docker exec -i authentik-postgres psql -U authentik -d postgres -c "DROP DATABASE IF EXISTS authentik;" && \
sudo docker exec -i authentik-postgres psql -U authentik -d postgres -c "CREATE DATABASE authentik;" && \
```

Restaurez la bdd

```shell
sudo docker exec authentik-postgresql pg_restore -U authentik -d authentik /path/to/wherever/mydb.tar
```