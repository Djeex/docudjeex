---
navigation: true
title: SWAG
main:
  fluid: false
---
:ellipsis{left=0px width=40rem top=10rem blur=140px}
# SWAG

::alert{type="info"}
ðŸŽ¯  __Objectifs :__
- Installer Swag
- Activer le SSL
- AccÃ©der au tableau de bord
- Configurer le blocage rÃ©gional
- Exposer Dockge
::

[Swag](https://docs.linuxserver.io/general/swag/) est le noyau de ce homelab. C'est un reverse proxy puissant qui permet d'exposer des services sur le net via un ou des noms de domaines, en se chargeant de l'Ã©mission des certificats SSL (pour garder des connexions chiffrÃ©es), du routage des requÃªtes et de la sÃ©curisation des accÃ¨s (par authent HTTP ou par SSO comme Authelia ou Authentik). Toute la doc nÃ©cessaire se [situe ici](https://docs.linuxserver.io/general/swag).

::alert{type="warning"}
:::list{type="warning"}
- SWAG n'a pour utilitÃ© que l'exposition de vos services sur internet. C'est Ã  dire, y accÃ©der via une url publique du type `https://service.mondomaine.fr`. Si vous ne souhaitez pas exposer vos services et plutÃ´t utiliser systÃ©matiquement un VPN pour vous connecter Ã  vos services Ã  distance, vous pouvez directement aller [par ici](/serveex/securite/wireguard). 
:::
::

Ci-dessous, vous trouverez un exemple, exposant Dockge. Nous installerons SWAG, ainsi que le mod dbip servant Ã  bloquer les connexions en fonction de la gÃ©oloc, ainsi que le mod dashboard qui permet de piloter le fonctionnement de swag, fail2ban et la gÃ©oloc.

**Principe d'un reverse proxy et application dans notre cas :**

![Picture](/img/serveex/reverse-proxy.svg)

## Installation
---

::alert{type="info" icon="exclamation-circle"}
:::list{type="info"}
- Ce tutoriel part du principe que vous avez un nom de domaine qui pointe vers votre serveur, et que votre box a une rÃ¨gle NAT qui redirige le port `443` vers l'adresse IP et le port `443` de votre serveur. Le nom de domaine d'exemple sera `mondomaine.fr`.
:::
::

Plan des fichiers que nous allons modifier :

```sh
root
â””â”€â”€ docker
    â””â”€â”€ swag
        â”œâ”€â”€ config
        â”‚   â”œâ”€â”€ dns-conf
        â”‚   â”‚   â””â”€â”€ ovh.ini
        â”‚   â””â”€â”€ nginx
        â”‚       â”œâ”€â”€ dbip.conf
        â”‚       â”œâ”€â”€ nginx.conf
        â”‚       â””â”€â”€ proxy-confs
        â”‚           â””â”€â”€ dockge.subdomain.conf      
        â”œâ”€â”€ compose.yml
        â””â”€â”€ .env
```

Ouvrez Dockge dans votre navigateur, cliquez sur `compose`, nommez la stack `swag` et copiez la conf ci-dessous

``` yaml
---
services:
  swag:
    image: lscr.io/linuxserver/swag:latest
    container_name: swag
    cap_add:
      - NET_ADMIN
    env_file:
      - .env
    environment:
      - TZ=Europe/Paris
      - URL=${DOMAIN}
      - EXTRA_DOMAINS=${DOMAINS}
      - SUBDOMAINS=wildcard # couvre les sous-domaines
      - VALIDATION=dns
      - DNSPLUGIN=${PLUGIN}
      - EMAIL=${EMAIL}
      - DOCKER_MODS=linuxserver/mods:swag-dbip|linuxserver/mods:swag-dashboard|linuxserver/mods:swag-auto-reload
    volumes:
      - /docker/swag/config:/config
    ports:
      - 80:80
      - 443:443
      - 81:81 # NÃ©cessaire pour le dashboard
    restart: unless-stopped
    networks:
      - swag

networks:
  swag:
    name: swag_default

```

::alert{type="success"}
âœ¨ __Astuce :__
ajoutez le label de watchtower dans chaque conteneur afin d'automatiser les mises Ã  jour
    
    ```yaml
    services:
      swag:
        #...
        labels:
          - com.centurylinklabs.watchtower.enable=true
::

Puis dans le `.env` :

```properties
DOMAIN=
DOMAINS=
EMAIL=
PLUGIN=
```

Remplissez comme suit 

| PropriÃ©tÃ©                | Valeur                                                                    | Exemples              |
|--------------------------|---------------------------------------------------------------------------|-----------------------|
| ` DOMAIN`{lang=properties}  | Votre domaine (cela couvre aussi tous les sous-domaines)                  | `mondomaine.fr`       |
| ` DOMAINS`{lang=properties} | Vos Ã©ventuels autres domaines                                             | `monsecondomaine.fr`  |
| ` EMAIL`{lang=properties}   | Votre email, pour gÃ©nÃ©rer le certificat                                   | `votre@email.fr`      |
| ` PLUGIN`{lang=properties}  | Le plugin pour gÃ©nÃ©rer le certificat, liÃ© Ã  votre [fournisseur de zone DNS](https://docs.linuxserver.io/general/swag/) | `ovh`<br>`cloudflare` |

Ici nous partons du principe que votre zone DNS est chez OVH. DÃ©ployez la stack une premiere fois. Dans les logs vous verrez qu'il n'arrivera pas Ã  crÃ©er de certificat SSL car le fichier ovh.ini renvoi une erreur. Arretez la stack.

En CLI, allez dans le dossier dns-conf et Ã©ditez le fichier `ovh.ini` :

::alert{type="success"}
âœ¨ __Astuce pour les allergiques au terminal :__
vous pouvez utiliser [File Browser](/serveex/files/file-browser) pour naviguer dans vos fichier et Ã©diter vos documents au lieu d'utiliser les commandes du terminal.
::


```sh
sudo vi /docker/swag/config/dns-conf/ovh.ini
```

Voici ce qui s'affiche :

```properties
# Instructions: https://github.com/certbot/certbot/blob/master/certbot-dns-ovh/certbot_dns_ovh/__init__.py#L20
# Replace with your values
dns_ovh_endpoint = ovh-eu
dns_ovh_application_key = 
dns_ovh_application_secret = 
dns_ovh_consumer_key = 
```
Authentifiez vous et crÃ©ez [votre token ici](https://www.ovh.com/auth/?onsuccess=https%3A%2F%2Fwww.ovh.com%2Fauth%2Fapi%2FcreateToken). 

Les permissions Ã  configurer sont les suivantes :

* ``GET /domain/zone/*``
* ``PUT /domain/zone/*``
* ``POST /domain/zone/*``
* ``DELETE /domain/zone/*``

Notez les 3 clÃ©s temporairement et renseignez le fichier `ovh.ini`. (avec vim, `i` pour passer en modif, `Echap` quand c'est fini, `:x` pour sauvegarder et quitter)

Sauvegardez et quittez le fichier. 

Configurez aussi swag pour qu'il accÃ¨de Ã  DBIP, le module de gestion des accÃ¨s par gÃ©olocalisation /Ouvrez le fichier nginx.conf

```sh
sudo vi /docker/swag/config/nginx/nginx.conf
```

Et ajoutez la ligne suivante en dessous de la section `http` :

```nginx
include /config/nginx/dbip.conf
```

Relancez la stack dans Dockge, cette fois le certificat SSL est bien Ã©mis ! VÃ©rifiez dans les logs que le serveur est bien ready.

## Dashboard
---
Accedez au dashboard via votre rÃ©seau local en tapant `http//ipdevotreserveur:81`
A gauche, vous trouverez la liste des services actuellement "proxied" (aucun pour le moment). A droite, les IP bannies. En-dessous, une liste d'indicateurs. pour le dÃ©tail, [c'est par ici](https://www.linuxserver.io/blog/introducing-swag-dashboard).

![picture](https://www.linuxserver.io/user/pages/03.blog/introducing-swag-dashboard/example.png)

## DBIP
---
DBIP permet de bloquer les connexions en fonction des pays. Il s'appuie sur le fichier de config nommÃ© `dbip.conf` dans `/docker/swag/config/nginx`. [Plus d'info ici](https://virtualize.link/secure/).

Dans cet exemple, nous allons le configurer pour bloquer une liste de pays connus pour etre Ã  l'origine de la plupart des connexions malveillantes. Nous allons Ã©galement configurer une variable au cas oÃ¹ nous souhaiterions permettre au rÃ©seau interne du serveur, au rÃ©seau local de votre box ainsi qu'Ã  un Ã©ventuel vpn en 10.x.x.x de pouvoir accÃ©der Ã  vos services, mais pas directement Ã  internet.

La configuration est activable ou dÃ©sactivable pour chaque service qui sera proxied (voir exemple de Dockge plus bas).

Ouvrez `dbip.conf` :

```sh
sudo vi /docker/swag/config/nginx/dbip.conf
```

Faites vos modifications ([voir documentation](https://github.com/linuxserver/docker-mods/tree/swag-dbip)), ou prenez l'exemple suivant: 

```nginx
geoip2 /config/geoip2db/dbip-country-lite.mmdb {
    auto_reload 1w;
    $geoip2_data_continent_code   continent code;
    $geoip2_data_country_iso_code country iso_code;
}

# Country Codes: https://en.wikipedia.org/wiki/ISO_3166-2

map $geoip2_data_country_iso_code $geo-whitelist {
    # default yes;
    # Example for whitelisting a country, comment out 'default yes;' above and uncomment 'default no;' and the whitelisted country below
    default no;
    FR yes;
}

map $geoip2_data_country_iso_code $geo-blacklist {
    default yes;
    # Example for blacklisting a country, uncomment the blacklisted country below
    CN no; #China
    RU no; #Russia
    HK no; #Hong Kong
    IN no; #India
    IR no; #Iran
    VN no; #Vietnam
    TR no; #Turkey
    EG no; #Egypt
    MX no; #Mexico
    JP no; #Japan
    KR no; #South Korea
    KP no; #North Korea
    PE no; #Peru
    BR no; #Brazil
    UA no; #Ukraine
    ID no; #Indonesia
    TH no; #Thailand
 }

geo $lan-ip {
    default no;
    10.0.0.0/8 yes;
    172.16.0.0/12 yes;
    192.168.0.0/16 yes;
    127.0.0.1 yes;
}
```

Sauvegardez et quittez. RedÃ©marrez la stack.

Dans les fichiers de conf des domaines (section suivante), vous pourrez activer ou dÃ©sactiver la whitelist ou la blacklist ([voir documentation ici](https://www.forum-nas.fr/threads/tuto-installer-swag-en-docker-reverse-proxy.15057/)). Dans notre cas, la whitelist laisse uniquement passer les requÃªtes franÃ§aises. La blacklist laisse passer tout le monde sauf la liste de pays mentionnÃ©e. On utilisera donc la blacklist, sur ce modÃ¨le :

```nginx
 server {
     listen 443 ssl;
     listen [::]:443 ssl;

     server_name some-app.*;
     include /config/nginx/ssl.conf;
     client_max_body_size 0;

     if ($geo-blacklist = no) { return 404; }

     location / {
```


## Exposer Dockge
---
::alert{type="info"}
ðŸ“‹ __PrÃ©requis :__ <br/></br>
Nous partons du principe que vous avez crÃ©Ã© dans votre [zone DNS](/generalites/reseau/dns) un sous domaine du type `dockge.mondomaine.fr` avec pour `CNAME` `mondomaine.fr` et [Ã  moins que vous utilisiez Cloudflare Zero Trust](/serveex/securite/cloudflare), que vous avez dÃ©jÃ  redirigÃ© le port `443` de votre box vers le `443` de votre serveur dans [les rÃ¨gles NAT](/generalites/reseau/nat).
::

Il s'agit maintenant d'exposer Dockge sur internet, afin de pouvoir y accÃ©der et gÃ©rer vos conteneurs sans que vous soyez chez vous. Pour cela, nous partons du principe que vous avez configurÃ© un sous domaine `dockge.mondomaine.fr` dans votre zone DNS dont le `CNAME` pointe sur `mondomaine.fr`.

::alert{type="warning"}
:::list{type="warning"}
- Dockge n'utilise pas d'authentification multifacteur. Exposer Dockge sur internet pourrait compromettre les machines auxquelles il est reliÃ©. Ne le faite que si vous utilisez un systeme d'authentification multifacteur comme [Authentik](/serveex/securite/authentik/). Sinon, n'exposez pas avec SWAG et utilisez plutÃ´t un VPN comme [Wireguard](/serveex/securite/wireguard).
:::
::

Ouvrez le fichier dockge.subdomain.conf :

```sh
sudo vi /docker/swag/config/nginx/proxy-confs/dockge.subdomain.conf
```

ParamÃ©trez le comme tel :

```nginx
## Version 2023/12/19

server {
    listen 443 ssl;
    listen [::]:443 ssl;
    
    # indique que le sous-domaine doit Ãªtre dirigÃ©
    server_name dockge.*;  

    include /config/nginx/ssl.conf;

    client_max_body_size 0;

    #if ($lan-ip = yes) { set $geo-whitelist yes; }
    #if ($geo-whitelist = no) { return 404; }
    # indique que les pays dans la blacklist sont intedits
    if ($geo-blacklist = no) { return 404; } 

    # enable for ldap auth (requires ldap-location.conf in the location block)
    #include /config/nginx/ldap-server.conf;

    # enable for Authelia (requires authelia-location.conf in the location block)
    #include /config/nginx/authelia-server.conf;

    # enable for Authentik (requires authentik-location.conf in the location block)
    #include /config/nginx/authentik-server.conf;

    location / {
        # enable the next two lines for http auth
        #auth_basic "Restricted";
        #auth_basic_user_file /config/nginx/.htpasswd;

        # enable for ldap auth (requires ldap-server.conf in the server block)
        #include /config/nginx/ldap-location.conf;

        # enable for Authelia (requires authelia-server.conf in the server block)
        #include /config/nginx/authelia-location.conf;

        # enable for Authentik (requires authentik-server.conf in the server block)
        #include /config/nginx/authentik-location.conf;

        include /config/nginx/proxy.conf;
        include /config/nginx/resolver.conf;
        
        set $upstream_app dockge; # Nom du conteneur
        set $upstream_port 5001; # Port interne conteneur
        set $upstream_proto http;
        proxy_pass $upstream_proto://$upstream_app:$upstream_port;

    }
}
```


Sauvegardez et quittez. La configuration va se mettre Ã  jour en quelques secondes. 
::alert{type="info"}
:::list{type="info"}
- Par dÃ©faut, SWAG ne connait pas le nom "dockge". Pour qu'il puisse y accÃ©der, vous devez rajouter le rÃ©seau de dockge dans le `compose.yml` de SWAG.
:::
::

Rendez-vous sur la stack de SWAG, puis cliquez sur `Ã©diter`, et ajouter le rÃ©seau de dockge dans le fichier de conf sur ce modele (les champs `networks`) :


```yaml
services:
  swag:
     container_name: #...
      # ... 
     networks:           # Relie le conteneur au rÃ©seau custom 
      - dockge           # Nom du rÃ©seau dÃ©clarÃ© dans la stack
    
networks:                # DÃ©finit le rÃ©seau custom
  #...
  dockge:                # Nom du rÃ©seau dÃ©clarÃ© dans la stack
    name: dockge_default # Nom vÃ©ritable du rÃ©seau externe
    external: true       # PrÃ©cise que c'est un rÃ©seau Ã  rechercher en externe
```

::alert{type="info"}
:::list{type="info"}
- Ici nous partons du principe que le nom du rÃ©seau de dockge est `dockge_default`. Vous pouvez vÃ©rifier que la connexion est opÃ©rationnelle en visitant le dashboard de SWAG en tapant `http://ipduserveur:81`.
:::
::

DÃ©ployez Ã  nouveau la stack de SWAG.

Patientez puis tapez `https://dockge.mondomaine.fr` dans votre navigateur, vous devriez Ãªtre redirigÃ© vers dockge. Vous pouvez vÃ©rifier le statut du service via le dashboard (depuis votre rÃ©seau local, http://ipdevotreserveur:81)


## Exposer un autre service avec SWAG
---
Swag dispose de modeles pour la plupart des services connus, nommÃ©s `nomduservice.subdomain.conf.sample`. Il vous suffit de crÃ©er le sous-domaine dans votre zone DNS chez votre registrar (comme OVH par exemple), de le faire pointer sur votre domaine principale (via un enregistrement CNAME) et de copier en renommant `nomduservice.subdomain.conf.sample` en `nomduservice.subdomain.conf`. 

```sh
cd /docker/swag/config/proxy-confs
sudo cp nomduservice.subdomain.conf.sample nomduservice.subdomain.conf
```
::alert{type="danger"}
:::list{type="danger"}
- __Si le sous domaine n'est pas redirigÃ© correctement__
:::
- Ã©ditez le fichier et vÃ©rifiez notamment le nom du conteneur dans `set $upstream_app nomduconteneur;`{lang=nginx}

- vÃ©rifiez que vous avez bien ajoutÃ© le rÃ©seau du conteneur dans le `compose.yml` de SWAG.
::

Vous pouvez aussi choisir le sous-domaine en changeant la variable `server_name votresousdomaine.*;`{lang=nginx} et en renommant le fichier `votresousdomaine.subdomain.conf`.