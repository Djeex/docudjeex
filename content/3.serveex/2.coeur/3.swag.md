---
navigation: true
title: SWAG
main:
  fluid: false
---
:ellipsis{left=0px width=40rem top=10rem blur=140px}
# SWAG

::alert{type="info"}
üéØ  __Objectifs :__
- Installer Swag
- Activer le SSL
- Acc√©der au tableau de bord
- Configurer le blocage r√©gional
- Exposer Dockge
::

[Swag](https://docs.linuxserver.io/general/swag/) est le noyau de ce homelab. C'est un reverse proxy puissant qui permet d'exposer des services sur le net via un ou des noms de domaines, en se chargeant de l'√©mission des certificats SSL (pour garder des connexions chiffr√©es), du routage des requ√™tes et de la s√©curisation des acc√®s (par authent HTTP ou par SSO comme Authelia ou Authentik). Toute la doc n√©cessaire se [situe ici](https://docs.linuxserver.io/general/swag).

::alert{type="warning"}
:::list{type="warning"}
- SWAG n'a pour utilit√© que l'exposition de vos services sur internet. C'est √† dire, y acc√©der via une url publique du type `https://service.mondomaine.fr`. Si vous ne souhaitez pas exposer vos services et plut√¥t utiliser syst√©matiquement un VPN pour vous connecter √† vos services √† distance, vous pouvez directement aller [par ici](/serveex/securite/wireguard). 
:::
::

Ci-dessous, vous trouverez un exemple, exposant Dockge. Nous installerons SWAG, ainsi que le mod dbip servant √† bloquer les connexions en fonction de la g√©oloc, ainsi que le mod dashboard qui permet de piloter le fonctionnement de swag, fail2ban et la g√©oloc.

**Principe d'un reverse proxy et application dans notre cas :**

![Picture](/img/serveex/reverse-proxy.svg)

## Installation
---

::alert{type="info" icon="exclamation-circle"}
:::list{type="info"}
- Ce tutoriel part du principe que vous avez un nom de domaine qui pointe vers votre serveur, et que votre box a une r√®gle NAT qui redirige le port `443` vers l'adresse IP et le port `443` de votre serveur. Le nom de domaine d'exemple sera `mondomaine.fr`.
:::
::

Plan des fichiers que nous allons modifier :

```sh
root
‚îî‚îÄ‚îÄ docker
    ‚îî‚îÄ‚îÄ swag
        ‚îú‚îÄ‚îÄ config
        ‚îÇ   ‚îú‚îÄ‚îÄ dns-conf
        ‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ ovh.ini
        ‚îÇ   ‚îî‚îÄ‚îÄ nginx
        ‚îÇ       ‚îú‚îÄ‚îÄ dbip.conf
        ‚îÇ       ‚îú‚îÄ‚îÄ nginx.conf
        ‚îÇ       ‚îî‚îÄ‚îÄ proxy-confs
        ‚îÇ           ‚îî‚îÄ‚îÄ dockge.subdomain.conf      
        ‚îú‚îÄ‚îÄ compose.yml
        ‚îî‚îÄ‚îÄ .env
```

Ouvrez Dockge dans votre navigateur, cliquez sur `compose`, nommez la stack `swag` et copiez la conf ci-dessous

``` yaml
---
services:
  swag:
    image: lscr.io/linuxserver/swag:latest
    container_name: swag
    cap_add:
      - NET_ADMIN
    env_file:
      - .env
    environment:
      - TZ=Europe/Paris
      - URL=${DOMAIN}
      - EXTRA_DOMAINS=${DOMAINS}
      - SUBDOMAINS=wildcard # couvre les sous-domaines
      - VALIDATION=dns
      - DNSPLUGIN=${PLUGIN}
      - EMAIL=${EMAIL}
      - DOCKER_MODS=linuxserver/mods:swag-dbip|linuxserver/mods:swag-dashboard|linuxserver/mods:swag-auto-reload
    volumes:
      - /docker/swag/config:/config
    ports:
      - 80:80
      - 443:443
      - 81:81 # N√©cessaire pour le dashboard
    restart: unless-stopped
    networks:
      - swag

networks:
  swag:
    name: swag_default

```

::alert{type="success"}
‚ú® __Astuce :__
ajoutez le label de watchtower dans chaque conteneur afin d'automatiser les mises √† jour
    
    ```yaml
    services:
      swag:
        #...
        labels:
          - com.centurylinklabs.watchtower.enable=true
::

Puis dans le `.env` :

```properties
DOMAIN=
DOMAINS=
EMAIL=
PLUGIN=
```

Remplissez comme suit 

| Propri√©t√©                | Valeur                                                                    | Exemples              |
|--------------------------|---------------------------------------------------------------------------|-----------------------|
| ` DOMAIN`{lang=properties}  | Votre domaine (cela couvre aussi tous les sous-domaines)                  | `mondomaine.fr`       |
| ` DOMAINS`{lang=properties} | Vos √©ventuels autres domaines                                             | `monsecondomaine.fr`  |
| ` EMAIL`{lang=properties}   | Votre email, pour g√©n√©rer le certificat                                   | `votre@email.fr`      |
| ` PLUGIN`{lang=properties}  | Le plugin pour g√©n√©rer le certificat, li√© √† votre [fournisseur de zone DNS](https://docs.linuxserver.io/general/swag/) | `ovh`<br>`cloudflare` |

Ici nous partons du principe que votre zone DNS est chez OVH. D√©ployez la stack une premiere fois. Dans les logs vous verrez qu'il n'arrivera pas √† cr√©er de certificat SSL car le fichier ovh.ini renvoi une erreur. Arretez la stack.

En CLI, allez dans le dossier dns-conf et √©ditez le fichier `ovh.ini` :

::alert{type="success"}
‚ú® __Astuce pour les allergiques au terminal :__
vous pouvez utiliser [File Browser](/serveex/files/file-browser) pour naviguer dans vos fichier et √©diter vos documents au lieu d'utiliser les commandes du terminal.
::


```sh
sudo vi /docker/swag/config/dns-conf/ovh.ini
```

Voici ce qui s'affiche :

```properties
# Instructions: https://github.com/certbot/certbot/blob/master/certbot-dns-ovh/certbot_dns_ovh/__init__.py#L20
# Replace with your values
dns_ovh_endpoint = ovh-eu
dns_ovh_application_key = 
dns_ovh_application_secret = 
dns_ovh_consumer_key = 
```
Authentifiez vous et cr√©ez [votre token ici](https://www.ovh.com/auth/?onsuccess=https%3A%2F%2Fwww.ovh.com%2Fauth%2Fapi%2FcreateToken). 

Les permissions √† configurer sont les suivantes :

* ``GET /domain/zone/*``
* ``PUT /domain/zone/*``
* ``POST /domain/zone/*``
* ``DELETE /domain/zone/*``

Notez les 3 cl√©s temporairement et renseignez le fichier `ovh.ini`. (avec vim, `i` pour passer en modif, `Echap` quand c'est fini, `:x` pour sauvegarder et quitter)

Sauvegardez et quittez le fichier. 

Configurez aussi swag pour qu'il acc√®de √† DBIP, le module de gestion des acc√®s par g√©olocalisation /Ouvrez le fichier nginx.conf

```sh
sudo vi /docker/swag/config/nginx/nginx.conf
```

Et ajoutez la ligne suivante en dessous de la section `http` :

```nginx
include /config/nginx/dbip.conf
```

Relancez la stack dans Dockge, cette fois le certificat SSL est bien √©mis ! V√©rifiez dans les logs que le serveur est bien ready.

## Dashboard
---
Accedez au dashboard via votre r√©seau local en tapant `http//ipdevotreserveur:81`
A gauche, vous trouverez la liste des services actuellement "proxied" (aucun pour le moment). A droite, les IP bannies. En-dessous, une liste d'indicateurs. pour le d√©tail, [c'est par ici](https://www.linuxserver.io/blog/introducing-swag-dashboard).

![picture](https://www.linuxserver.io/user/pages/03.blog/introducing-swag-dashboard/example.png)

## DBIP
---
DBIP permet de bloquer les connexions en fonction des pays. Il s'appuie sur le fichier de config nomm√© `dbip.conf` dans `/docker/swag/config/nginx`. [Plus d'info ici](https://virtualize.link/secure/).

Dans cet exemple, nous allons le configurer pour bloquer une liste de pays connus pour etre √† l'origine de la plupart des connexions malveillantes. Nous allons √©galement configurer une variable au cas o√π nous souhaiterions permettre au r√©seau interne du serveur, au r√©seau local de votre box ainsi qu'√† un √©ventuel vpn en 10.x.x.x de pouvoir acc√©der √† vos services, mais pas directement √† internet.

La configuration est activable ou d√©sactivable pour chaque service qui sera proxied (voir exemple de Dockge plus bas).

Ouvrez `dbip.conf` :

```sh
sudo vi /docker/swag/config/nginx/dbip.conf
```

Faites vos modifications ([voir documentation](https://github.com/linuxserver/docker-mods/tree/swag-dbip)), ou prenez l'exemple suivant: 

```nginx
geoip2 /config/geoip2db/dbip-country-lite.mmdb {
    auto_reload 1w;
    $geoip2_data_continent_code   continent code;
    $geoip2_data_country_iso_code country iso_code;
}

# Country Codes: https://en.wikipedia.org/wiki/ISO_3166-2

map $geoip2_data_country_iso_code $geo-whitelist {
    # default yes;
    # Example for whitelisting a country, comment out 'default yes;' above and uncomment 'default no;' and the whitelisted country below
    default no;
    FR yes;
}

map $geoip2_data_country_iso_code $geo-blacklist {
    default yes;
    # Example for blacklisting a country, uncomment the blacklisted country below
    CN no; #China
    RU no; #Russia
    HK no; #Hong Kong
    IN no; #India
    IR no; #Iran
    VN no; #Vietnam
    TR no; #Turkey
    EG no; #Egypt
    MX no; #Mexico
    JP no; #Japan
    KR no; #South Korea
    KP no; #North Korea
    PE no; #Peru
    BR no; #Brazil
    UA no; #Ukraine
    ID no; #Indonesia
    TH no; #Thailand
 }

geo $lan-ip {
    default no;
    10.0.0.0/8 yes;
    172.16.0.0/12 yes;
    192.168.0.0/16 yes;
    127.0.0.1 yes;
}
```

Sauvegardez et quittez. Red√©marrez la stack.

Dans les fichiers de conf des domaines (section suivante), vous pourrez activer ou d√©sactiver la whitelist ou la blacklist ([voir documentation ici](https://www.forum-nas.fr/threads/tuto-installer-swag-en-docker-reverse-proxy.15057/)). Dans notre cas, la whitelist laisse uniquement passer les requ√™tes fran√ßaises. La blacklist laisse passer tout le monde sauf la liste de pays mentionn√©e. On utilisera donc la blacklist, sur ce mod√®le :

```nginx
 server {
     listen 443 ssl;
     listen [::]:443 ssl;

     server_name some-app.*;
     include /config/nginx/ssl.conf;
     client_max_body_size 0;

     if ($geo-blacklist = no) { return 404; }

     location / {
```


## Exposer Dockge
---
::alert{type="info"}
üìã __Pr√©requis :__ <br/></br>
Nous partons du principe que vous avez cr√©√© dans votre [zone DNS](/generalites/reseau/dns) un sous domaine du type `dockge.mondomaine.fr` avec pour `CNAME` `mondomaine.fr` et [√† moins que vous utilisiez Cloudflare Zero Trust](/serveex/securite/cloudflare), que vous avez d√©j√† redirig√© le port `443` de votre box vers le `443` de votre serveur dans [les r√®gles NAT](/generalites/reseau/nat).
::

Il s'agit maintenant d'exposer Dockge sur internet, afin de pouvoir y acc√©der et g√©rer vos conteneurs sans que vous soyez chez vous. Pour cela, nous partons du principe que vous avez configur√© un sous domaine `dockge.mondomaine.fr` dans votre zone DNS dont le `CNAME` pointe sur `mondomaine.fr`.

::alert{type="warning"}
:::list{type="warning"}
- Dockge n'utilise pas d'authentification multifacteur. Exposer Dockge sur internet pourrait compromettre les machines auxquelles il est reli√©. Ne le faite que si vous utilisez un systeme d'authentification multifacteur comme [Authentik](/serveex/securite/authentik/). Sinon, n'exposez pas avec SWAG et utilisez plut√¥t un VPN comme [Wireguard](/serveex/securite/wireguard).
:::
::

Ouvrez le fichier dockge.subdomain.conf :

```sh
sudo vi /docker/swag/config/nginx/proxy-confs/dockge.subdomain.conf
```

Param√©trez le comme tel :

```nginx
## Version 2023/12/19

server {
    listen 443 ssl;
    listen [::]:443 ssl;
    
    # indique que le sous-domaine doit √™tre dirig√©
    server_name dockge.*;  

    include /config/nginx/ssl.conf;

    client_max_body_size 0;

    #if ($lan-ip = yes) { set $geo-whitelist yes; }
    #if ($geo-whitelist = no) { return 404; }
    # indique que les pays dans la blacklist sont intedits
    if ($geo-blacklist = no) { return 404; } 

    # enable for ldap auth (requires ldap-location.conf in the location block)
    #include /config/nginx/ldap-server.conf;

    # enable for Authelia (requires authelia-location.conf in the location block)
    #include /config/nginx/authelia-server.conf;

    # enable for Authentik (requires authentik-location.conf in the location block)
    #include /config/nginx/authentik-server.conf;

    location / {
        # enable the next two lines for http auth
        #auth_basic "Restricted";
        #auth_basic_user_file /config/nginx/.htpasswd;

        # enable for ldap auth (requires ldap-server.conf in the server block)
        #include /config/nginx/ldap-location.conf;

        # enable for Authelia (requires authelia-server.conf in the server block)
        #include /config/nginx/authelia-location.conf;

        # enable for Authentik (requires authentik-server.conf in the server block)
        #include /config/nginx/authentik-location.conf;

        include /config/nginx/proxy.conf;
        include /config/nginx/resolver.conf;
        
        set $upstream_app dockge; # Nom du conteneur
        set $upstream_port 5001; # Port interne conteneur
        set $upstream_proto http;
        proxy_pass $upstream_proto://$upstream_app:$upstream_port;

    }
}
```


Sauvegardez et quittez. La configuration va se mettre √† jour en quelques secondes. 
::alert{type="info"}
:::list{type="info"}
- Par d√©faut, SWAG ne connait pas le nom "dockge". Pour qu'il puisse y acc√©der, vous devez rajouter le r√©seau de dockge dans le `compose.yml` de SWAG.
:::
::

Rendez-vous sur la stack de SWAG, puis cliquez sur `√©diter`, et ajouter le r√©seau de dockge dans le fichier de conf sur ce modele (les champs `networks`) :


```yaml
services:
  swag:
     container_name: #...
      # ... 
     networks:           # Relie le conteneur au r√©seau custom 
      - dockge           # Nom du r√©seau d√©clar√© dans la stack
    
networks:                # D√©finit le r√©seau custom
  #...
  dockge:                # Nom du r√©seau d√©clar√© dans la stack
    name: dockge_default # Nom v√©ritable du r√©seau externe
    external: true       # Pr√©cise que c'est un r√©seau √† rechercher en externe
```

::alert{type="info"}
:::list{type="info"}
- Ici nous partons du principe que le nom du r√©seau de dockge est `dockge_default`. Vous pouvez v√©rifier que la connexion est op√©rationnelle en visitant le dashboard de SWAG en tapant `http://ipduserveur:81`.
:::
::

D√©ployez √† nouveau la stack de SWAG.

Patientez puis tapez `https://dockge.mondomaine.fr` dans votre navigateur, vous devriez √™tre redirig√© vers dockge. Vous pouvez v√©rifier le statut du service via le dashboard (depuis votre r√©seau local, http://ipdevotreserveur:81)


## Exposer un autre service avec SWAG
---
Swag dispose de modeles pour la plupart des services connus, nomm√©s `nomduservice.subdomain.conf.sample`. Il vous suffit de cr√©er le sous-domaine dans votre zone DNS chez votre registrar (comme OVH par exemple), de le faire pointer sur votre domaine principale (via un enregistrement CNAME) et de copier en renommant `nomduservice.subdomain.conf.sample` en `nomduservice.subdomain.conf`. 

```sh
cd /docker/swag/config/proxy-confs
sudo cp nomduservice.subdomain.conf.sample nomduservice.subdomain.conf
```
::alert{type="danger"}
:::list{type="danger"}
- __Si le sous domaine n'est pas redirig√© correctement__
:::
- √©ditez le fichier et v√©rifiez notamment le nom du conteneur dans `set $upstream_app nomduconteneur;`{lang=nginx}

- v√©rifiez que vous avez bien ajout√© le r√©seau du conteneur dans le `compose.yml` de SWAG.
::

Vous pouvez aussi choisir le sous-domaine en changeant la variable `server_name votresousdomaine.*;`{lang=nginx} et en renommant le fichier `votresousdomaine.subdomain.conf`.