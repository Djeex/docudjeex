---
navigation: true
title: Beszel
main:
  fluid: false
---
:ellipsis{left=0px width=40rem top=10rem blur=140px}
# Beszel

::alert{type="info"}
üéØ __Objectifs :__
- Installer Beszel
- Monitorer le serveur local
- Monitorer un serveur distant
- Exposer Beszel avec Swag
::

[Beszel](https://beszel.dev/) est un conteneur permettant d'acc√©der aux informations du hardware de vos serveurs en temps r√©el et de les historiser. Activit√© CPU, usages des disques, temp√©ratures, RAM, vous ne raterez rien de l'√©tat de votre serveur. Beszel permet √©galement de param√©trer des notifications et alertes en cas de d√©passement de limites que vous avez choisies.

Beszel dispose d'un hub avec une webui et d'un agent qui permet de collecter les donn√©es depuis votre serveur ou sur un serveur distant.

![Beszel](/img/serveex/beszel.png)

## Installation
---

Structure des dossiers

```sh
root
‚îî‚îÄ‚îÄ docker
    ‚îî‚îÄ‚îÄ beszel
        ‚îú‚îÄ‚îÄ data
        ‚îî‚îÄ‚îÄ socket

```

Ouvrez Dockge, cliquez sur `compose`, appelez la stack `beszel` puis copiez collez ceci :

```yaml
---
services:
  beszel:
    image: henrygd/beszel:latest
    container_name: beszel
    restart: unless-stopped
    ports:
      - ${PORT}:8090
    volumes:
      - ./data:/beszel_data
      - ./socket:/beszel_socket

  beszel-agent:
    image: henrygd/beszel-agent:latest
    container_name: beszel-agent
    restart: unless-stopped
    network_mode: host
    volumes:
      - ./socket:/beszel_socket
      - /var/run/docker.sock:/var/run/docker.sock:ro
    environment:
      LISTEN: /beszel_socket/beszel.sock
      # Do not remove quotes around the key
      KEY: ${KEY}
```

::alert{type="success"}
‚ú® __Astuce :__ ajoutez le label de watchtower dans chaque conteneur afin d'automatiser les mises √† jour

    ```yaml
    services:
      beszel:
        #...
        labels:
          - com.centurylinklabs.watchtower.enable=true
::

Renseignez le `.env`, par exemple :

```properties
PORT=8090 # port de la webui
KEY= # cl√© priv√©e √† r√©cup√©rer dans Beszel lors que vous ajoutez un syst√®me
```
Pour la valeur `KEY`, il faudra lancer Beszel une premi√®re fois pour la saisir.

D√©ployez le conteneur et rendez-vous sur `http://ipduserveur:8090`. Et voil√†, votre instance Beszel en webui est disponible !

::alert{type="danger"}
:::list{type="danger"}
- __En cas d'√©chec :__ v√©rifiez les r√®gles de votre pare-feu.
:::
::

### Ajouter les informations du serveur local

Maintenant que la webui est accessible, vous devez faire remonter les informations du serveur dedans. Pour cela, il vous suffit d'ajouter une machine dans la webui et de param√©ter comme ceci :

![Beszel add system](/img/serveex/beszel-add.png)

Note la cl√© priv√©e et validez. Renseignez la cl√© dans votre `.env` dans dockge, et red√©ployez la stack. Lorsque vous retournerez sur la webui, votre serveur apparaitra :

![Beszel add system](/img/serveex/beszel-system.png)


### Ajouter les informations d'un serveur distant

Vous pouvez √©galement monitorer un serveur distant. Pour cela vous avez juste √† faire tourner l'agent sur le serveur distant. Pour cela, ajoutez une nouvelle machine dans Beszel et renseignez :

- Le nom qui s'affichera dans Beszel pour votre serveur distant
- L'adresse IP ou le nom de domaine de votre serveur distant
- Le port d'√©coute de votre serveur distant (dans notre exemple cela sera `45876`)

Beszel vous proposera de copier directement le `compose.yaml` √† d√©ployer sur votre serveur distant, ou vous pouvez le configurer comme suit :

```yaml
---
services:
  beszel-agent:
    image: henrygd/beszel-agent
    container_name: beszel-agent
    restart: unless-stopped
    network_mode: host
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock:ro
    environment:
      LISTEN: ${PORT}
      KEY: ${KEY}
```

Et dans le `.env` :

```properties
PORT=45876 # port de communication entre votre hub et l'agent √† distance
KEY= # cl√© priv√©e √† r√©cup√©rer dans Beszel lors que vous ajoutez un syst√®me
```
D√©ployez la stack sur votre serveur distant. Les informations du serveur distant remontront au bout de quelques secondes dans votre webui.

::alert{type="danger"}
:::list{type="danger"}
- __En cas d'√©chec :__ v√©rifiez les r√®gles de votre pare-feu.
:::
::

## Exposer Beszel avec Swag
---

::alert{type="warning"}
:::list{type="warning"}
- Beszel n'utilise pas d'authentification multifacteur. Exposer Beszel sur internet pourrait compromettre les machines auxquelles il est reli√©. Ne le faite que si vous utilisez un systeme d'authentification multifacteur comme [Authentik](/serveex/securite/authentik/). Sinon, n'exposez pas avec SWAG et utilisez plut√¥t un VPN comme [Wireguard](/serveex/securite/wireguard).
:::
::

Vous aurez peut-etre envie d'y acc√©der √† distance et sur tout vos appareils. Pour cela, nous allons exposer Beszel via Swag.

::alert{type="info"}
üìã __Au pr√©alable :__
<br/><br/>
Nous partons du principe que vous avez cr√©√© dans votre [zone DNS](/generalites/reseau/dns) un sous domaine du type `beszel.mondomaine.fr` avec pour `CNAME` `mondomaine.fr` et, [√† moins que vous utilisiez Cloudflare Zero Trust](/serveex/securite/cloudflare), que que vous avez d√©j√† redirig√© le port `443` de votre box vers le `443` de votre serveur dans [les r√®gles NAT](/generalites/reseau/nat).
::

Rendez-vous dans dockge, et √©ditez le compose de SWAG en ajoutant le r√©seau de Beszel :

```yaml
services:
  swag:
     container_name: # ...
      # ... 
     networks:            # Relie le conteneur au r√©seau custom 
      # ...           
      - beszel            # Nom du r√©seau d√©clar√© dans la stack
    
networks:                 # D√©finit le r√©seau custom
  # ...
  beszel:                 # Nom du r√©seau d√©clar√© dans la stack
    name: beszel_default  # Nom v√©ritable du r√©seau externe
    external: true        # Pr√©cise que c'est un r√©seau √† rechercher en externe
```

Relancez la stack en cliquant sur "d√©ployer" et patientez le temps que SWAG soit compl√®tement op√©rationnel.

::alert{type="info"}
:::list{type="info"}
- Ici nous partons du principe que le nom du r√©seau de beszel est `beszel_default`. Vous pouvez v√©rifier que la connexion est op√©rationnelle en visitant le dashboard de SWAG en tapant `http://ipduserveur:81`.
:::
::

Dans les dossiers de Swag, cr√©ez le fichier `beszel.subdomain.conf`.

::alert{type="success"}
‚ú® __Astuce :__ vous pouvez utiliser [File Browser](/serveex/files/file-browser) pour naviguer dans vos fichier et √©diter vos documents au lieu d'utiliser les commandes du terminal.
::

```sh
sudo vi /docker/swag/config/nginx/proxy-confs/beszel.subdomain.conf
```
Entrez en modification avec la touche `i` et collez la configuration ci-dessous :

```nginx
## Version 2023/12/19

server {
    listen 443 ssl;
    listen [::]:443 ssl;

    server_name beszel.*;

    include /config/nginx/ssl.conf;

    client_max_body_size 0;

    #if ($lan-ip = yes) { set $geo-whitelist yes; }
    #if ($geo-whitelist = no) { return 404; }
    if ($geo-blacklist = no) { return 404; }

    # enable for ldap auth (requires ldap-location.conf in the location block)
    #include /config/nginx/ldap-server.conf;

    # enable for Authelia (requires authelia-location.conf in the location block)
    #include /config/nginx/authelia-server.conf;

    # enable for Authentik (requires authentik-location.conf in the location block)
    #include /config/nginx/authentik-server.conf;

    location / {
        # enable the next two lines for http auth
        #auth_basic "Restricted";
        #auth_basic_user_file /config/nginx/.htpasswd;

        # enable for ldap auth (requires ldap-server.conf in the server block)
        #include /config/nginx/ldap-location.conf;

        # enable for Authelia (requires authelia-server.conf in the server block)
        #include /config/nginx/authelia-location.conf;

        # enable for Authentik (requires authentik-server.conf in the server block)
        #include /config/nginx/authentik-location.conf;

        include /config/nginx/proxy.conf;
        include /config/nginx/resolver.conf;
        set $upstream_app beszel;
        set $upstream_port 8090;
        set $upstream_proto http;
        proxy_pass $upstream_proto://$upstream_app:$upstream_port;

    }
}
```

Appuyez sur `Echap` puis sauvegardez et quittez en tapant `:x` puis en appuyant sur `Entr√©e`.

Et voil√†, vous avez expos√© Beszel !

::alert{type="success"}
‚ú® Vous pouvez prot√©ger cette app avec Authentik en ouvrant `beszel.subodmain.conf` et en retirant les `#` devant `include /config/nginx/authentik-server.conf;`{lang=nginx} et `include /config/nginx/authentik-location.conf;`{lang=nginx}. N'oubliez pas de [cr√©er une application et un fournisseur dans Authentik](/serveex/securite/authentik#prot√©ger-une-app-par-reverse-proxy).
::