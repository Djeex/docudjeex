---
navigation: true
title: Adguard Home
main:
  fluid: false
---
:ellipsis{left=0px width=40rem top=10rem blur=140px}
# Adguard Home

::alert{type="info"}
üéØ __Objectifs :__
- Installer et d√©ployer Adguard
- Exposer Adguard
- S√©curiser les requ√™tes avec SSL/TLS
- Configurer les appareils clients
::

[AdGuard Home](https://github.com/AdguardTeam/AdGuardHome) est un serveur DNS anti-pub et anti-tra√ßage qui fonctionne au niveau du syst√®me. Une fois configur√©, il couvrira TOUS vos appareils domestiques et vous n'aurezbesoin d'aucun logiciel c√¥t√© client pour cela.

Il fonctionne comme un serveur DNS qui redirige les domaines de suivi vers un ¬´black hole¬ª, emp√™chant ainsi vos appareils de se connecter √† ces serveurs. 

En pratique, une fois en place, il vous faudra juste configurer les serveurs DNS de vos appareils, pour que ces derniers l'utilisent.

**Rappel sur le fonctionnement d'un DNS :**

Lorsque vous naviguez sur un site, ou une application, des requ√™tes sont √©mises vers un ou des domaines afin d'afficher le contenu de votre page. Les publicit√©s notamment. Votre appareil ne connait pas les adresses IP de ces serveurs √† joindre. Pour les connaitre, il va contacter un _serveur de nom_ (Domain Name Server) qui lui va lui r√©pondre avec l'adresse IP la plus √† jour pour le domaine de la requ√™te. 

Par d√©faut, votre appareil utilise le serveur votre fournisseur d'acc√®s, param√©tr√© dans votre box ou directement sur le CGNAT de votre op√©rateur si appareil mobile. Cela peut etre chang√© directement dans les r√©glages de votre navigateur, mais aussi dans le syst√®me de votre appareil, et parfois directement dans votre box si votre FAI le permet.

Adguard lui, va s'intercaler entre le serveur de nom et votre appareil. Si vous param√©trez vos appareil, ils contacteront d'abord adguard qui filtrera les requetes, via des listes r√©guli√®rement mises √† jour :

- Si le domaine n'est pas dans une blocklist, il contactera des serveurs de noms g√©n√©riques (dit upstreams) et r√©pondra vers vos appareils avec l'adresse IP recherch√©e.
- Si le domaine est dans une blocklist, il ne contactera pas les DNS upstream et ne r√©pondre pas √† vos appareils. Le contenu affili√© √† cette requete ne s'affichera pas.

C'est ainsi que les pubs et domaines malveillants sont bloqu√©s : leurs domaines sont pr√©sents dans la blocklist, le reste de la page lui charge correctement.

![Picture](/img/serveex/adguard.svg)
## Installation
---
Structure des dossiers : 

```sh
root
‚îî‚îÄ‚îÄ docker
    ‚îî‚îÄ‚îÄ adguard
        ‚îú‚îÄ‚îÄ confdir
        ‚îú‚îÄ‚îÄ workdir
        ‚îú‚îÄ‚îÄ compose.yaml
        ‚îî‚îÄ‚îÄ .env
```

::alert{type="info"}
:::list{type="info"}
- Nous monterons aussi le dossier `/docker/swag/config/etc/letsencrypt` afin d'avoir acc√®s au certificat SSL de Swag.
:::
::

Ouvrez Dockge, et cliquez sur `compose`

Nommez la stack `adguardhome` et copiez la configuration ci-dessous

```yaml
---
services:
  
  adguardhome:
    container_name: adguard
    image: adguard/adguardhome
    restart: unless-stopped
    ports:
      - 53:53/udp
      - 8080:80/tcp
      - 4443:443/tcp
      - 853:853/tcp
      - 3000:3000/tcp
    volumes:
      - /docker/adguardhome/confdir:/opt/adguardhome/conf
      - /docker/adguardhome/workdir:/opt/adguardhome/work
      - /docker/swag/config/etc/letsencrypt:/swag-ssl:ro

```



::alert{type="success"}
‚ú® __Astuce :__ Ajoutez le label de watchtower dans chaque conteneur afin d'automatiser les mises √† jour

    ```yaml
    services:
      adguardhome:
        #...
        labels:
          - com.centurylinklabs.watchtower.enable=true
::

D√©ployez la stack.

Rendez-vous sur `http//ipduserveur:3000` et suivez les instructions

Et voil√†, vous avez d√©ploy√© Adguard !

## Exposer Adguard avec Swag
---
Pour √™tre utilisable hors de chez vous, vous devez exposer Adguard

::alert{type="info"}
:::list{type="info"}
- __Au pr√©alable :__ nous partons du principe que vous avez cr√©√© dans votre [zone DNS](/generalites/reseau/dns) un sous domaine du type `adguard.mondomaine.fr` avec pour `CNAME` `mondomaine.fr` et que que vous avez d√©j√† redirig√© le port `443` de votre box vers le `443` de votre serveur dans [les r√®gles NAT](/generalites/reseau/nat). Redirigez √©galement le port `53` et le port `853` vers votre serveur. Ces ports serviront √† router les requ√™tes DNS.
:::
::

::alert{type="warning"}
:::list{type="warning"}
- N'utilisez pas les tunnels cloudflare pour exposer Adguard, et d√©sactivez tout proxy.
:::
::

Dans Dockge, rendez-vous dans la stack de SWAG et √©ditez le compose en ajoutant le r√©seau d'adguard :

```yaml
services:
  swag:
     container_name: # ...
      # ... 
     networks:             # Relie le conteneur au r√©seau custom 
      # ...           
      - adguard            # Nom du r√©seau d√©clar√© dans la stack
    
networks:                  # D√©finit le r√©seau custom
  # ...
  adguard:                 # Nom du r√©seau d√©clar√© dans la stack
    name: adguard_default  # Nom v√©ritable du r√©seau externe
    external: true         # Pr√©cise que c'est un r√©seau √† rechercher en externe
```

::alert{type="info"}
:::list{type="info"}
- Ici nous partons du principe que le nom du r√©seau d'adguard est `adguard_default`. Vous pouvez v√©rifier que la connexion est op√©rationnelle en visitant le dashboard de SWAG en tapant http://ipduserveur:81.
:::
::

Relancez la stack en cliquant sur "d√©ployer" et patientez le temps que SWAG soit compl√®tement op√©rationnel.
    
Cr√©ez et ouvrez le fichier `adguard.subdomain.conf`

::alert{type="success"}
‚ú® __Astuce pour les allergiques au terminal :__
vous pouvez utiliser [File Browser](/serveex/files/file-browser) pour naviguer dans vos fichier et √©diter vos documents au lieu d'utiliser les commandes du terminal.
::

```sh
sudo vi /docker/swag/config/nginx/proxy-confs/adguard.subdomain.conf
```

Editez le fichier en appuyant sur `i` puis copiez la configuration ci-dessous :

```nginx
## Version 2023/05/31
# make sure that your adguard container is named adguard
# make sure that your dns has a cname set for adguard

server {
    listen 443 ssl;
    listen [::]:443 ssl;

    server_name adguard.*;

    include /config/nginx/ssl.conf;

    client_max_body_size 0;

    #if ($lan-ip = yes) { set $geo-whitelist yes; }
    #if ($geo-whitelist = no) { return 404; }
    if ($geo-blacklist = no) { return 404; }

    # enable for ldap auth (requires ldap-location.conf in the location block)
    #include /config/nginx/ldap-server.conf;

    # enable for Authelia (requires authelia-location.conf in the location block)
    #include /config/nginx/authelia-server.conf;

    # enable for Authentik (requires authentik-location.conf in the location block)
    #include /config/nginx/authentik-server.conf;

    location / {
        # enable the next two lines for http auth
        #auth_basic "Restricted";
        #auth_basic_user_file /config/nginx/.htpasswd;

        # enable for ldap auth (requires ldap-server.conf in the server block)
        #include /config/nginx/ldap-location.conf;

        # enable for Authelia (requires authelia-server.conf in the server block)
        #include /config/nginx/authelia-location.conf;

        # enable for Authentik (requires authentik-server.conf in the server block)
        #include /config/nginx/authentik-location.conf;

        include /config/nginx/proxy.conf;
        include /config/nginx/resolver.conf;
        set $upstream_app adguard;
        set $upstream_port 3000;
        set $upstream_proto http;
        proxy_pass $upstream_proto://$upstream_app:$upstream_port;

    }

    location /control {
        include /config/nginx/proxy.conf;
        include /config/nginx/resolver.conf;
        set $upstream_app adguard;
        set $upstream_port 3000;
        set $upstream_proto http;
        proxy_pass $upstream_proto://$upstream_app:$upstream_port;

    }

    location /dns-query {
        # to properly use this please set `allow_unencrypted_doh: true` and `force_https: false` in adguard
        # see https://github.com/AdguardTeam/AdGuardHome/wiki/Configuration#configuration-file
        include /config/nginx/proxy.conf;
        include /config/nginx/resolver.conf;
        set $upstream_app adguard;
        set $upstream_port 3000;
        set $upstream_proto http;
        proxy_pass $upstream_proto://$upstream_app:$upstream_port;

    }
}

```

::alert{type="success"}
‚ú® __Astuce :__ 
<br/><br/>
Vous pouvez prot√©ger cette app avec Authentik en ouvrant `adguard.subdomain.conf` et en retirant les `#` devant `include /config/nginx/authentik-server.conf;`{lang=nginx} et `include /config/nginx/authentik-location.conf;`{lang=nginx}. n'oubliez pas de [cr√©er une application et un fournisseur dans Authentik](/serveex/securite/authentik/#prot√©ger-une-app-par-reverse-proxy). Il vous faudra exclure l'url `https://adguard.mondomaine.fr/dns-query` de l'authentification :

- Editez le fournisseur d'Adguard
- Dans *param√®tres avanc√©s du protocole > chemins authentifi√©s*, saisissez `^/dns-query`
::

Appuyez sur `Echap` puis sauvegardez et quittez en tapant `:x`

Et voil√†, vous exposez Adguard √† pr√©sent !

## Configurer le chiffrement SSL/TLS
---
Le chiffrement est essentiel si vous souhaitez garder priv√©es les requ√™tes que vous faites vers adguard. Chiffrer ces requ√™tes c'est vous assurez que personne, meme votre FAI ne connaissent votre historique. C'est aussi vous assurer que personne d'autre que votre serveur vous r√©pond.

Afin de configurer le chiffrement :

- Allez dans _param√®tre_ puis dans _chiffrement_.
- Parametrez comme suit

![Picture](/img/serveex/adguard-chiffrement.png)

- Puis en dessous, dans la section _certificats_ cochez _D√©finir un emplacement de fichier du certificat_
- Dans le champs de saisie, mettez `/swag-ssl/live/mondomaine.fr/fullchain.pem` en rempla√ßant `mondomaine.fr` par votre domaine principal.
- Dans _cl√© priv√©e_ cochez _D√©finir un fichier pour la clef priv√©e_
- Dans le champs de saisie, mettez `/swag-ssl/live/mondomaine.fr/privkey.pem` en rempla√ßant `mondomaine.fr` par votre domaine principal.
- Validez

Et voil√† ! Vous avez prot√©g√© vos futures requ√™tes DNS !

## Configurer les appareils
---
Pour configurer vos appareils, vous avez plusieurs choix (que vous pouvez cumuler).
### S√©curiser le r√©seau local
Vous pouvez s√©curiser votre r√©seau local avec adguard en configurant votre box pour que chaque requ√™te DNS soit dirig√©e par d√©faut vers adguard plutot que les services de votre FAI. Attention, votre box doit pouvoir permettre le changement de DNS (Orange ne le permet pas). 

G√©n√©ralement cette option est dans les param√®tres _DHCP_ de votre box. Pensez bien √† ajouter un serveur secondaire tel que :

- Cloudlare : `1.1.1.1`
- Google : `8.8.8.8`

En effet, sans cela, si votre serveur tombe, vos appareils n'arriveraient plus √† se connecter √† internet.

::alert{type="info"}
:::list{type="info"}
- Des appareils peuvent avoir un autre DNS param√©tr√© et ne pas utiliser ceux de la box.
:::
::

### Forcer un navigateur √† utiliser Adguard

Dans votre navigateur, vous pouvez configurer un DNS pour le forcer √† utiliser adguard home.
Dans les param√®tres, il vous faudra renseigner l'adresse` https://adguard.mondomaine.fr/dns-query`

### Windows, param√©trer Adguard au niveau syst√®me

Dans windows, vous devez param√©trer Adguard pour chaque carte r√©seau que vous souhaitez utiliser. 

- Rendez vous dans _accueil > R√©seau et internet >_ et choisissez votre carte r√©seau √† modifier
- Cliquez sur _modifier les DNS_ (parfois dans _propri√©t√© du mat√©riel_)
- Choisissez `Manuel`
- Activez IPv4
- Renseignez l'IP publique de votre serveur (celle accessible depuis internet)
- Activez _DNS sur HTTPS (mod√®le manuel)_
- D√©sactivez _retour au texte en clair_
- Enregistrez

Tous les programmes de votre machine utilisant cette carte r√©seau seront filtr√©s par Adguard.


## Ajouter des filtres
---

- Allez dans les param√®tres et changez les filtres.