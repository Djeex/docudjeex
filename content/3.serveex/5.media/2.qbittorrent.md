---
navigation: true
title: Qbittorrent
main:
  fluid: false
---
:ellipsis{left=0px width=40rem top=10rem blur=140px}
# Qbittorrent

::alert{type="info"}
üéØ __Objectifs :__
- Installer et configurer Qbittorrent
- Etre reli√© au r√©seau bittorent en toute s√©curit√© avec Gluetun et Proton VPN
::

![Picture](https://github.com/VueTorrent/VueTorrent/blob/master/public/screenshots/screenshot-desktop-dark-mode.jpeg?raw=true)

Afin de t√©l√©chargez vos media favoris en toute s√©curit√©, nous allons monter un syst√®me √† base de :

- [Qbittorent](https://github.com/linuxserver/docker-qbittorrent) comme logiciel de t√©l√©chargement bittorent
- [Proton VPN Plus](https://protonvpn.com/torrenting), VPN pour s√©curiser vos √©changes, auquel vous devez souscrire (il y a de nombreux codes promo) pour acc√©der au protocole Bittorent, mais vous pouvez √©galement en choisir un autre, √† condition qu'il propose le protocole bittorent.
- [Gluetun](https://github.com/qdm12/gluetun)
- [Qbittorrent port update](https://codeberg.org/TechnoSam/qbittorrent-gluetun-port-update) pour mettre automatiquement √† jour le port de votre VPN (qui change r√©guli√®rement).
- Et le mode [vuetorrent](https://github.com/gabe565/linuxserver-mod-vuetorrent) pour une interface moderne et intuitive.

Nous monterons ici le syst√®me ci-dessous :

![Picture](/img/serveex/qbit.svg)

## Configuration
---
Structure des dossiers

```console
root
‚îú‚îÄ‚îÄ docker
‚îÇ   ‚îî‚îÄ‚îÄ seedbox
‚îÇ       ‚îú‚îÄ‚îÄ qbittorrent
‚îÇ       ‚îÇ   ‚îî‚îÄ‚îÄ config
‚îÇ       ‚îú‚îÄ‚îÄ gluetun
‚îÇ       ‚îú‚îÄ‚îÄ compose.yaml
‚îÇ       ‚îî‚îÄ‚îÄ .env
‚îÇ       
‚îî‚îÄ‚îÄ media #reli√© √† plex et Qbittorrent
    ‚îú‚îÄ‚îÄ downloads #vos t√©l√©chargements g√©n√©riques, √† selectionner dans les parametres
    ‚îú‚îÄ‚îÄ movies #√† selectionner dans l'interface pour t√©l√©charger vos films
    ‚îî‚îÄ‚îÄ tvseries #√† selectionner dans l'interface pour t√©l√©charger vos s√©ries
```

Si ce n'est pas d√©j√† fait, cr√©ez le dossier `downloads` dans `/media` :

```sh
mkdir -P /media/downloads
```

Ouvrez Dockge, cliquez sur `compose` et nommez la stack `seedbox`. Collez la config ci-dessous : 

```yaml
---
services:
  qbit:
    image: ghcr.io/linuxserver/qbittorrent:latest
    container_name: qbittorrent
    restart: unless-stopped
    network_mode: service:gluetun
    mem_limit: 1g
    environment:
      - DOCKER_MODS=ghcr.io/gabe565/linuxserver-mod-vuetorrent|ghcr.io/t-anc/gsp-qbittorent-gluetun-sync-port-mod:main
      - TZ=Europe/Paris
      - PUID=${PUID}
      - PGID=${GUID}
      - WEBUI_PORT=${UI_PORT}
      - GSP_GTN_API_KEY=${GSP_KEY}
      - GSP_QBT_USERNAME=${ID}
      - GSP_QBT_PASSWORD=${PW}
    volumes:
      - /docker/seedbox/qbittorrent/config:/config
      - /media:/media
    depends_on:
      - gluetun

  gluetun:
    image: qmcgaw/gluetun:v3.40
    container_name: gluetun
    restart: unless-stopped
    mem_limit: 1g
    volumes:
      - /docker/gluetun/config.toml:/gluetun/auth/config.toml:ro
    devices:
      - /dev/net/tun:/dev/net/tun
    ports:
      - ${UI_PORT}:5695 # Port de la web-ui
      - 8000:8000 # Port de controle de Gluetun
    cap_add:
      - NET_ADMIN
    environment:
      - TZ=Europe/Paris
      - VPN_SERVICE_PROVIDER=protonvpn
      - VPN_PORT_FORWARDING=on
      - VPN_PORT_FORWARDING_PROVIDER=protonvpn
      - VPN_TYPE=wireguard
      - WIREGUARD_PRIVATE_KEY=${PR_KEY}
      - SERVER_COUNTRIES=France
      - PORT_FORWARD_ONLY=on
      
```


::alert{type="success"}
‚ú® __Astuce :__ ajoutez le label de watchtower dans chaque conteneur afin d'automatiser les mises √† jour

    ```yaml
    services:
      qbittorrent:
        #...
        labels:
          - com.centurylinklabs.watchtower.enable=true
      gluetun:
        #...
        labels:
          - com.centurylinklabs.watchtower.enable=true
::

Avant de renseigner le `.env` dans Dockge, nous allons configurer la mise √† jour du port de t√©l√©chargement. En effet, Proton, et la plupart des VPN, changent r√©guli√®rement le port de t√©l√©chargement, et celui-ci doit etre communiqu√© √† Qbitorrent. 

Pour ce faire, nous avons ajout√© le mod `ghcr.io/t-anc/gsp-qbittorent-gluetun-sync-port-mod` dans le conteneur. 

Il faut √† pr√©sent permettre au mod de r√©cup√©rer l'information via Gluetun, qui n'accepte que les communications chiffr√©es via son API.

A cet effet, ouvrez un terminal. Nous allons √† pr√©sent g√©n√©rer une cl√© d'authentification :

```shell
sudo docker run --rm qmcgaw/gluetun genkey
```

Notez la cl√©. Puis cr√©ez le dossier `/docker/gluetun`

```shell
sudo mkdir /docker/gluetun
```

Et cr√©ez le fichier `config.toml`

```shell
sudo vi /docker/gluetun/config.toml
```

Entrez en modification en tapant `i` et √©ditez le comme suit en ajoutant la cl√©e que vous avez g√©n√©r√©e :

```toml
[[roles]]
name = "t-anc/GSP-Qbittorent-Gluetun-sync-port-mod"
routes = ["GET /v1/openvpn/portforwarded"]
auth = "apikey"
apikey = "votre_cl√©e" # cl√©e que vous avez g√©n√©r√©e pr√©c√©demment
```

Appuyez sur `√©chap` et quittez en sauvegardant en tapant `:x`. Rendez-vous dans Dockge, et renseignez les variables dans `.env`:

```properties
PUID=
GUID=
UI_PORT=
PR_KEY=
GSP_KEY= # la cl√© que vous avez g√©n√©r√©e et renseign√©e dans config.toml
ID=
PW=
```

En d√©tails :

| Variable                    | Valeur                                                                                                                                            | Exemples                     |
|-----------------------------|---------------------------------------------------------------------------------------------------------------------------------------------------|------------------------------|
| `PUID`{lang=properties}      | A renseigner avec les infos de votre user (trouvables via la commande `id nomdutilisateur`{lang=shell})                                         | `1000`                         |
| `GUID`{lang=properties}   | A renseigner avec les infos de votre user (trouvables via la commande `id nomdutilisateur`{lang=shell})                                         | `1000`                         |
| `UI_PORT`{lang=properties}     | Le port d'acc√®s √† la web ui, elle sera joignable via `http//ipduserveur:port`                                                                     | `5695`                         |
| `PR_KEY`{lang=properties}      | La cl√©e priv√©e fournie par Proton                                                                                                                 | `buKsjNHLyzKMM1qYnzOy4s7SHfly` |
| `GSP_KEY`{lang=properties}     | Cl√© que vous avez g√©n√©r√©e pour la mise √† jour du port         | `MnBa47MeVmk7xiv`                |
| `ID`{lang=properties}     | username que vous utilisez pour vous logger dans l'interface de Qbittorrent         | `user`                |
| `PW`{lang=properties}     | mot de passe que vous utilisez pour vous logger dans l'interface de Qbittorrent         | `password`                |

## D√©ploiement
---
Une fois fait, d√©ployez le conteneur.


::alert{type="warning"}
:::list{type="warning"}
- **Dans les logs de lancement, vous trouverez un mot de passe temporaire pour l'utilisateur `admin`**
:::
::

Loggez vous sur `http://ipduserveur:5695` (ou le port que vous avez configur√©). 

::alert{type="danger"}
:::list{type="danger"}
- __En cas d'√©chec :__ v√©rifiez les r√®gles de votre pare-feu.
:::
::

Changez votre nom d'utilisateur et votre mot de passe dans les param√®tres "webui".

Et voil√† ! Dans les param√®tres de Qbittorrent, dans "t√©l√©chargements" selectionnez `/media/downloads` comme chemin par d√©faut pour t√©l√©charger vos media.

Lorsque vous lancez un t√©l√©chargement, n'oubliez pas de pr√©ciser le bon r√©pertoire de t√©l√©chargement afin que Plex puisse synchroniser correctement sa biblioth√®que (`/media/movies` et `/media/tvseries`). Vous pouvez aussi l'automatiser en cr√©ant une cat√©gorie et un r√©pertoire associ√©.

## Exposer la webui
---

::alert{type="warning"}
:::list{type="warning"}
- Qbitorrent n'utilise pas d'authentification multifacteur. Exposer Qbitorrent sur internet pourrait compromettre les machines auxquelles il est reli√©. Ne le faite que si vous utilisez un systeme d'authentification multifacteur comme [Authentik](/serveex/securite/authentik/). Sinon, n'exposez pas avec SWAG et utilisez plut√¥t un VPN comme [Wireguard](/serveex/securite/wireguard).
:::
::


Afin de lancer des t√©l√©chargement hors de chez vous, sans VPN, vous pouvez exposer la webui de Qbittorrent. 

::alert{type="info"}
:::list{type="info"}
- Nous partons du principe que vous avez le sous-domaine `seedbox.mondomaine.fr` avec un `CNAME` qui pointe vers `mondomaine.fr` dans [zone DNS](/generalites/reseau/dns). Et que bien s√ªr, [√† moins que vous utilisiez Cloudflare Zero Trust](/serveex/securite/cloudflare), le port `443` de votre box pointe bien sur le port `443` de votre serveur dans [les r√®gles NAT](/generalites/reseau/nat).
:::
::

Rendez-vous dans dockge, et √©ditez le compose de SWAG en ajoutant le r√©seau de Gluetun :

```yaml
services:
  swag:
     container_name: # ...
      # ... 
     networks:             # Relie le conteneur au r√©seau custom 
      # ...           
      - seedbox            # Nom du r√©seau d√©clar√© dans la stack
    
networks:                  # D√©finit le r√©seau custom
  # ...
  seedbox:                 # Nom du r√©seau d√©clar√© dans la stack
    name: seedbox_default  # Nom v√©ritable du r√©seau externe
    external: true         # Pr√©cise que c'est un r√©seau √† rechercher en externe
```

Relancez la stack en cliquant sur "d√©ployer" et patientez le temps que SWAG soit compl√®tement op√©rationnel.

::alert{type="info"}
:::list{type="info"}
- Ici nous partons du principe que le nom du r√©seau de la seedbox est `seedbox_default`. Vous pouvez v√©rifier que la connexion est op√©rationnelle en visitant le dashboard de SWAG en tapant http://ipduserveur:81.
:::
::


Puis nous allons cr√©er et √©diter le fichier `seedbox.subdomain.conf`.

::alert{type="success"}
‚ú®__Astuce pour les allergiques au terminal :__ vous pouvez utiliser [File Browser](/serveex/files/file-browser) pour naviguer dans vos fichier et √©diter vos documents au lieu d'utiliser les commandes du terminal.
::

```shell
sudo vi /docker/swag/config/nginx/proxy-confs/seedbox.subdomain.conf
```

Entrez en modification en appuyant sur `i` et copiez la configuration ci-dessous, en prenant soin de v√©rifier le port : 

```nginx
## Version 2023/12/19

server {
    listen 443 ssl;
    listen [::]:443 ssl;

    server_name seedbox.*;

    include /config/nginx/ssl.conf;

    client_max_body_size 0;

    #if ($lan-ip = yes) { set $geo-whitelist yes; }
    #if ($geo-whitelist = no) { return 404; }
    if ($geo-blacklist = no) { return 404; }

    # enable for ldap auth (requires ldap-location.conf in the location block)
    #include /config/nginx/ldap-server.conf;

    # enable for Authelia (requires authelia-location.conf in the location block)
    #include /config/nginx/authelia-server.conf;

    # enable for Authentik (requires authentik-location.conf in the location block)
    #include /config/nginx/authentik-server.conf;

    location / {
        # enable the next two lines for http auth
        #auth_basic "Restricted";
        #auth_basic_user_file /config/nginx/.htpasswd;

        # enable for ldap auth (requires ldap-server.conf in the server block)
        #include /config/nginx/ldap-location.conf;

        # enable for Authelia (requires authelia-server.conf in the server block)
        #include /config/nginx/authelia-location.conf;

        # enable for Authentik (requires authentik-server.conf in the server block)
        #include /config/nginx/authentik-location.conf;

        include /config/nginx/proxy.conf;
        include /config/nginx/resolver.conf;
        set $upstream_app gluetun;
        set $upstream_port 5555;
        set $upstream_proto http;
        proxy_pass $upstream_proto://$upstream_app:$upstream_port;

    }
}
```
::alert{type="success"}
‚ú® Vous pouvez prot√©ger cette app avec Authentik en retirant les `#` devant `include /config/nginx/authentik-server.conf;`{lang=nginx} et `include /config/nginx/authentik-location.conf;`{lang=nginx}. N'oubliez pas de [cr√©er une application et un fournisseur dans Authentik](/serveex/securite/authentik#prot√©ger-une-app-par-reverse-proxy).
::

Appuyez sur `Echap` puis sauvegardez et quittez en tapant `:x`.

Patientez quelques minutes puis tapez dans votre navigateur `https://seedbox.mondomaine.fr`, vous arriverez sur l'interface de Qbittorrent.

Et voil√†, vous avez un mediacenter pret √† l'emploi !

![Picture](/img/serveex/seed.svg)
