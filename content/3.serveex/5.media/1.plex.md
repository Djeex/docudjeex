---
navigation: true
title: Plex
main:
  fluid: false
---
:ellipsis{left=0px width=40rem top=10rem blur=140px}
# Plex

::alert{type="info"}
üéØ __Objectifs :__
- Installer Plex
- Installer Tautulli
- Acc√©der aux media depuis l'exterieur
::

[Plex](https://www.plex.tv/fr/) est une plateforme de streaming vid√©o d√©ployable chez vous, pour manager votre biblioth√®que de films ou de s√©rie, et les lire en locale ou √† distance. Plex dispose d'applications TV, Android, iOS, Window et Mac OS, permettant la lecture de vos biblioth√®ques, √† la Netflix. 

Avec le *plexpass*, vous pouvez √©galement organsier et lire vos contenus audio, √† la spotify, la diff√©rence √©tant que c'est bien votre contenu qui est h√©berg√© et lu depuis chez vous.

![picture](/img/serveex/plex.png)

On installera √©galement [Tautulli](https://docs.linuxserver.io/images/docker-tautulli/), un outil qui permet d'avoir des stats pouss√©es sur Plex. On utilisera, comme d√®s qu'on le peut, les images de linuxserver.io.

- [Plus d'info sur le conteneur Plex](https://docs.linuxserver.io/images/docker-plex)
- [Plus d'info sur le conteneur Tautulli](https://docs.linuxserver.io/images/docker-tautulli/)

::alert{type="info"}
:::list{type="info"}
- Vous serez amen√©s √† creer un compte *Plex.tv*. Vous n'avez pas besoin d'exposer votre service Plex, il sera accessible directement par la plateforme. Votre serveur Plex sera g√©rable directement depuis votre compte.
:::
::

## Installer Plex
---
Structure des dossiers :
```console
root
‚îú‚îÄ‚îÄ docker
‚îÇ   ‚îú‚îÄ‚îÄ plex      
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ compose.yml
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ .env
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ config
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ transcode
‚îÇ   ‚îî‚îÄ‚îÄ tautulli
‚îÇ       ‚îî‚îÄ‚îÄ config
‚îî‚îÄ‚îÄ media
    ‚îú‚îÄ‚îÄ tvseries
    ‚îú‚îÄ‚îÄ movies
    ‚îî‚îÄ‚îÄ library
```

Cr√©ez les dossiers `movies`, `tvseries` et `library` dans /media :

```sh
mkdir -p /media/movies /media/library /media/tvseries
```

Ouvrez Dockge dans votre navigeateur, et cliquez sur `compose`.
Nommez la stack `plex` et ajoutez la config suivante :

```yaml
---
services:
  linuxserver_plex:
    image: ghcr.io/linuxserver/plex:amd64-latest
    container_name: plex
    network_mode: host
    environment:
      - PUID=${PUID}
      - PGID=${GUID}
      - TZ=Europe/Paris
      - VERSION=docker
    volumes:
      - /docker/plex/config:/config
      - /docker/plex/transcode:/transcode
      - /media:/media
    restart: unless-stopped
    mem_limit: 4096m
    mem_reservation: 2048m
    devices:
      - /dev/dri:/dev/dri
  
  tautulli:
    image: lscr.io/linuxserver/tautulli:latest
    container_name: tautulli
    environment:
      - PUID=${PUID}
      - PGID=${GUID}
      - TZ=Europe/Paris
    volumes:
      - /docker/tautulli/config:/config
    ports:
      - 8181:8181
    restart: unless-stopped
```

::alert{type="success"}
‚ú® Ajoutez le label de watchtower dans chaque conteneur afin d'automatiser les mises √† jour

    ```yaml
    services:
      plex:
        #...
        labels:
          - com.centurylinklabs.watchtower.enable=true
          
      tautulli:
        #...
        labels:
          - com.centurylinklabs.watchtower.enable=true
::

Trouvez votre PUID et votre GUID en tapant la commande suivante :

```shell
id nomdutilisateur
```
Et renseignez le `.env` avec les infos que vous avez trouv√©es, par exemple :

```properties
PUID=1000
GUID=1000
```
D√©ployez la stack.

L'interface locale est disponible via `http://ipduserveur:32400/web/index.html`. L'interface de Tautulli est joignable via `http://ipduserveur:8181`.

::alert{type="warning"}
:::list{type="warning"}
- Vous devez imp√©rativement √™tre sur votre r√©seau local au moment du premier setup de Plex, sans quoi l'url vous renverra sur votre compte Plex sans detecter votre serveur. Un VPN ne vous sauvera pas. Si vous ne pouvez pas faire autrement, [vous pouvez g√©rer l'installation √† distance via un tunnel SSH](https://support.plex.tv/articles/200288586-installation/#toc-2).
:::
::

## Param√©trer Plex
---
Plex propose tout une gamme de film/s√©rie gratuitement. Apr√®s avoir cr√©√© votre compte, et pour ne pas polluer votre biblioth√®que, je vous conseille de tout d√©sactiver dans la section _Services en ligne_.

Ensuite rendez-vous dans la section _Acc√®s √† distance_ et choisissez un port manuellement (ici cela sera `1234`). Il est pr√©f√©rable de ne pas garder le port d'origine.

![picture](/img/serveex/plex-port.png)

- Sur votre routeur, redirigez le port `TCP` source `1234` vers le port `32400`, vers l'IP de votre serveur via [les r√®gles NAT](/generalites/nat).
- Une fois fait, retournez dans Plex afin de v√©rifier que la connexion est bien op√©rationnelle

::alert{type="danger"}
:::list{type="danger"}
- __En cas d'√©chec :__ v√©rifiez les r√®gles de votre pare-feu et autorisez le port `32400` de votre serveur.
:::
::

- Si vous avez un abonnement PlexPass et un GPU ou iGPU, activez *l'acc√©l√©ration mat√©rielle* dans la section _Transcodeur_.
- Dans la section _R√©glages/biblioth√®que_, cochez _Analyser ma biblioth√®que automatiquement_.
- Dans la section _G√©rer/biblioth√®que_ modifiez ou ajouter les biblioth√®que, et choisissez le r√©pertoire `/media/movies` pour les films et `/media/tvseries` pour les s√©ries.

Et voil√†, vous avez un Plex fonctionnel ! 

Vous n'avez plus qu'a remplir les dossiers `/media/movies` et `/media/tvseries` sur votre serveur de vos m√©dia favoris. Vous pourrez alors t√©l√©charger l'application Plex sur vos appareils et lire vos m√©dia favoris, chez vous ou √† distance !

::alert{type="info"}
:::list{type="info"}
- Si pour stocker vos m√©dia vous utilisez un disque r√©seau (par exemple un stockage sur un NAS ou un disque dur externe branch√© ailleurs sur le r√©seau), veuillez consulter la section [montage samba](/generalites/samba) afin que Plex puisse y acc√©der.
:::
::

## Exposer Tautulli avec Swag
---
Plex n'a pas besoin d'etre expos√©, √©tant joignable directement depuis votre compte Plex sur plex.tv. 

En  revanche, vous pouvez d√©sirer exposer Tautulli, afin d'acc√©der aux stats m√™me si vous n'est pas chez vous, depuis une simple url.
::alert{type="info"}
:::list{type="info"}
- Nous partons du principe que vous avez le sous-domaine `tautulli.mondomaine.fr` avec un `CNAME` qui pointe vers `mondomaine.fr` dans [zone DNS](/generalites/dns). Et que bien s√ªr, [√† moins que vous utilisiez Cloudflare Zero Trust](/serveex/securite/cloudflare), le port `443` de votre box pointe bien sur le port `443` de votre serveur dans [les r√®gles NAT](/generalites/nat).
:::
::


Rendez-vous dans dockge, et √©ditez le compose de SWAG en ajoutant le r√©seau de Tautulli :

```yaml
services:
  swag:
     container_name: # ...
      # ... 
     networks:              # Relie le conteneur au r√©seau custom 
      # ...           
      - tautulli            # Nom du r√©seau d√©clar√© dans la stack
    
networks:                   # D√©finit le r√©seau custom
  # ...
  tautulli:                 # Nom du r√©seau d√©clar√© dans la stack
    name: tautulli_default  # Nom v√©ritable du r√©seau externe
    external: true          # Pr√©cise que c'est un r√©seau √† rechercher en externe
```

Relancez la stack en cliquant sur "d√©ployer" et patientez le temps que SWAG soit compl√®tement op√©rationnel.

::alert{type="info"}
:::list{type="info"}
- Ici nous partons du principe que le nom du r√©seau de Tautulli est `tautulli_default`. Vous pouvez v√©rifier que la connexion est op√©rationnelle en visitant le dashboard de SWAG en tapant `http://ipduserveur:81`.
:::
::

Copiez en renommant le fichier `tautulli.subdomain.conf.sample` en `tautulli.subdomain.conf` et √©ditez le :

::alert{type="success"}
‚ú® __Astuce :__ vous pouvez utiliser [File Browser](/serveex/files/file-browser) pour naviguer dans vos fichier et √©diter vos documents au lieu d'utiliser les commandes du terminal.
::

```shell
sudo cp /docker/swag/config/nginx/proxy-confs/tautulli.subdomain.conf.sample /docker/swag/config/nginx/proxy-confs/tautulli.subdomain.conf
sudo vi /docker/swag/config/nginx/proxy-confs/tautulli.subdomain.conf
```

Et v√©rifiez que la configuration correspond bien √† ceci, sinon √©ditez le fichier en appuyant sur `i`:

```nginx
## Version 2023/05/31
# make sure that your tautulli container is named tautulli
# make sure that your dns has a cname set for tautulli

server {
    listen 443 ssl;
    listen [::]:443 ssl;

    server_name tautulli.*;

    include /config/nginx/ssl.conf;

    client_max_body_size 0;

    # enable for ldap auth (requires ldap-location.conf in the location block)
    #include /config/nginx/ldap-server.conf;

    # enable for Authelia (requires authelia-location.conf in the location block)
    #include /config/nginx/authelia-server.conf;

    # enable for Authentik (requires authentik-location.conf in the location block)
    #include /config/nginx/authentik-server.conf;

    location / {
        # enable the next two lines for http auth
        #auth_basic "Restricted";
        #auth_basic_user_file /config/nginx/.htpasswd;

        # enable for ldap auth (requires ldap-server.conf in the server block)
        #include /config/nginx/ldap-location.conf;

        # enable for Authelia (requires authelia-server.conf in the server block)
        #include /config/nginx/authelia-location.conf;

        # enable for Authentik (requires authentik-server.conf in the server block)
        #include /config/nginx/authentik-location.conf;

        include /config/nginx/proxy.conf;
        include /config/nginx/resolver.conf;
        set $upstream_app tautulli;
        set $upstream_port 8181;
        set $upstream_proto http;
        proxy_pass $upstream_proto://$upstream_app:$upstream_port;

    }

    location ~ (/tautulli)?/api {
        include /config/nginx/proxy.conf;
        include /config/nginx/resolver.conf;
        set $upstream_app tautulli;
        set $upstream_port 8181;
        set $upstream_proto http;
        proxy_pass $upstream_proto://$upstream_app:$upstream_port;

    }

    location ~ (/tautulli)?/newsletter {
        include /config/nginx/proxy.conf;
        include /config/nginx/resolver.conf;
        set $upstream_app tautulli;
        set $upstream_port 8181;
        set $upstream_proto http;
        proxy_pass $upstream_proto://$upstream_app:$upstream_port;

    }

    location ~ (/tautulli)?/image {
        include /config/nginx/proxy.conf;
        include /config/nginx/resolver.conf;
        set $upstream_app tautulli;
        set $upstream_port 8181;
        set $upstream_proto http;
        proxy_pass $upstream_proto://$upstream_app:$upstream_port;

    }
}
```

::alert{type="success"}
‚ú® Vous pouvez prot√©ger cette app avec Authentik en retirant les `#` devant `include /config/nginx/authentik-server.conf;`{lang=nginx} et `include /config/nginx/authentik-location.conf;`{lang=nginx}. N'oubliez pas de [cr√©er une application et un fournisseur dans Authentik](/serveex/securite/authentik#prot√©ger-une-app-par-reverse-proxy).
::

Appuyez sur `Echap` puis sauvegardez et quittez en tappant `:x`

Patientez quelques minutes puis tapez dans votre navigateur `http://tautulli.mondomaine.fr`.

::alert{type="danger"}
:::list{type="danger"}
- __En cas d'√©chec :__ v√©rifiez les r√®gles de votre pare-feu.
:::
::

Et voil√† !