---
navigation: true
title: Samba
main:
  fluid: false
---
:ellipsis{left=0px width=40rem top=10rem blur=140px}
# Samba

Samba est un protocole permettant d'acc√®der √† un dossier situ√© sur un disque r√©seau. Il peut √™tre configur√© sous Mac, Windows ou Linux.

De nombreux tutorials existent pour configurer Samba sous windows ou sur un NAS type Synology, ici nous nous concentrons sur Debian.

::alert{type="info"}
üéØ __Objectifs :__
- Cr√©er un dossier r√©seau sur une machine distante
- Acc√©der au dossier r√©seau sur notre serveur
::

![samba](/img/global/smb.svg)

## Partager un dossier r√©seau
---
::alert{type="info"}
:::list{type="info"}
- Ici, nous allons partager le dossier `/video` d'une machine distant que nous appelerons `machine-distante`. Nous acc√©derons √† ce dossier par la machine nomm√©e `machine-locale`. L'utilisateur de connexion au disque r√©seau sera `sambauser`.
:::
::


### Installer le serveur samba

```sh
sudo apt update && sudo apt upgrade
sudo apt install samba smbclient cifs-utils
```

### Cr√©er le dossier `/video`

```sh
sudo mkdir /video
```

### Configuration du partage

Ensuite nous allons √©diter le fichier `/etc/samba/smb.conf`

::alert{type="success"}
‚ú® __Astuce :__ vous pouvez utiliser [File Browser](/serveex/files/file-browser) pour naviguer dans vos fichier et √©diter vos documents au lieu d'utiliser les commandes du terminal.
::

```sh
sudo vim /etc/samba/smb.conf
```

Localisez la variable `workgroup` puis passez en mode modification en appuyant sur `i` et nommez votre worgroup, par exemple `::::properties workgroup = WORKGROUP`

Puis allez √† la fin du fichier et collez la configuration suivante

```properties
[video]
   comment = Dossier video
   path = /video
   writable = yes
   guest ok = no
   valid users = @smbshare
   force create mode = 770
   force directory mode = 770
   inherit permissions = yes
```
Appuyez sur `Echap` pour quitter le mode notification puis tapez `:x` et appuyez sur `Entr√©e` pour sauvegarder et quitter.

### Cr√©er un utilisateur et un groupe pour Samba

Comme nous avons configfur√© un partage s√©curis√©, nous allons devoir cr√©er un utilisateur et un groupe pour pouvoir y acc√©der √† distance.

Creez le groupe.
```sh
sudo groupadd smbshare
```

Nous allons maintenant permettre au groupe d'avoir le controle sur le dossier `/video`.

```sh
sudo chgrp -R smbshare /video
```

Et maintenant nous allons donner les permissions n√©cessaires aux dossiers et fichier h√©rit√©s.

```sh
sudo chmod 2775 /video
```

A pr√©sent nous allons ajouter un utilisateur nologin c'est √† dire que cet utilisateur ne pourra pas se connecter sur le serveur pour faire des op√©rations, mais pourra tout de meme se connecter au service samba.

```sh
sudo useradd -M -s /sbin/nologin sambauser
```

Puis nous ajoutons l'utilisateur au groupe `sambashare` que nous avons cr√©√© pr√©c√©demment.


```sh
sudo usermod -aG smbshare sambauser
```
Et nous allons configurer un mot de passe.

```sh
sudo smbpasswd -a sambauser
```
Et enfin nous allons activer le compte que nous venons de cr√©er.

```sh
sudo smbpasswd -e sambauser
```
::alert{type="warning"}
:::list{type="warning"}
- __Attention :__ Si vous utilisez un pare-feu, comme ufw, n'oubliez pas d'autoriser les IP des machines qui acc√©deront √† votre dossier partag√© :
:::
    ```sh
    sudo ufw allow from ipdelamachine to any app Samba
::


## Acc√©der √† un dossier partag√©
---
::alert{type="info"}
:::list{type="info"}
- A pr√©sent, nous sommes sur votre `machine-locale` qui n√©cessite d'acc√©der au dossier partag√© `/video` pr√©sent sur la `machine-distante`.
:::
::

### Installer les package n√©cessaires

```sh
sudo apt update && sudo apt upgrade
sudo apt install cifs-utils
```
### Cr√©er le dossier de destination

Nous allons cr√©er un dossier sur notre serveur sur lequel sera mont√© le dossier partag√© de notre `machine-distante. C'est √† dire que dans ce dossier nous retrouverons le contenu du dossier partag√© de notre `machine-distante`. Ici nous appellerons ce dossier `/mnt/video`.

```sh
sudo mkdir /mnt/video
```

### Pr√©parer le fichier .credentials

Afin de ne pas avoir syst√©matiquement √† rentrer notre utilisateur et mot de passe, nous allons cr√©er un fichier .credentials` stockant ces informations.

Nous allons le cr√©er dans le dossier `/smb`.

```sh
sudo mkdir /smb
sudo vi /smb/.credentials
```
Passez en mode modification en appuyant sur `i` et configurez comme suit :

```properties
username=smbuser
password=motdepasse
```

- `smbuser` : L'utilisateur que nous avons configur√© sur la `machine-distante`
- `motdepasse` : Le mot de passe que nous avons configur√© sur la `machine-distante`

Appuyez sur `Echap` afin de quitter le mode modification, puis tapez `:x` et appuyez sur `Entr√©e` pour sauvegarder et quitter.

Nous allons modifier les permissions du dossier afin que seul le propri√©taire puis lire et √©crire dans ce fichier.

```sh
sudo chmod 600 /smb/.credentials
```

### Monter le dossier partager

A pr√©sent nous allons monter le dossier.

```sh
sudo mount -t cifs -o credentials=/smb/.credentials //ip-machine-distante/video /mnt/video
```

Remplacez `ip-machine-distante` par l'adresse IP de votre `machine-distante`

V√©rifiez que cela a fonctionn√© en tapant :

```sh
sudo mount -t cifs
```
Vous verrez diff√©rentes informations qui confirmerons le succ√®s du montage.

Et voil√†, √† pr√©sent vous acc√©dez au dossier /video de `votre machine-distante`, depuis votre `machine-locale` !

### Automatiser le montage au boot

Par d√©faut, les dossiers pattag√©s ne sont pas connect√©s automatiquement au red√©marrage. Pour autoamtiser cet aspect, nous allons modifier le fichier `/etc/fstab`.

D'abord, sauvegardons notre fichier `fstab`.

```sh
sudo cp /etc/fstab /etc/fstab.bak
```

Puis nous allons ajouter une ligne √† la fin du fichier comportant les informations de montages dans le fichier `fstab`.

```sh
sudo echo //ip-machine-distante/video    /mnt/video  cifs   _netdev,nofail,credentials=/smb/.credentials,x-systemd.automount,x-systemd.device-timeout=15 0 0 >> /etc/fstab
```

Red√©marrez.

```sh
sudo reboot
```

Une fois red√©marr√©, v√©rifiez que le montage est correct

```sh
sudo mount -t cifs
```

Et voil√† !

### D√©monter le dossier partag√©

```sh
sudo umount -t cifs /mnt/video
```